<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQL 运维, wb">
    <meta name="description" content="MySQL 是一款安全、跨平台、高效的，并与 PHP、Java 等主流编程语言紧密结合的数据库系统。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MySQL 运维 | wb</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="wb" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">wb</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">wb</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/images/MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MySQL 运维</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MySQL-%E8%BF%90%E7%BB%B4/">
                                <span class="chip bg-color">MySQL 运维</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                数据库
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-05-15
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-04-05
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    16.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    72 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1-日志"><a href="#1-日志" class="headerlink" title="1. 日志"></a>1. 日志</h1><h2 id="1-1-错误日志"><a href="#1-1-错误日志" class="headerlink" title="1.1 错误日志"></a>1.1 错误日志</h2><p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。</p>
<p>该日志是默认开启的，默认存放目录 /var/log/，默认的日志文件名为 mysqld.log 。查看日志位置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">show variables like '<span class="token operator">%</span>log_error<span class="token operator">%</span>'<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97.jpg" alt="错误日志"></p>
<h2 id="1-2-二进制日志"><a href="#1-2-二进制日志" class="headerlink" title="1.2 二进制日志"></a>1.2 二进制日志</h2><h3 id="1-2-1-介绍"><a href="#1-2-1-介绍" class="headerlink" title="1.2.1 介绍"></a>1.2.1 介绍</h3><p>二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但不包括数据查询（SELECT、SHOW）语句。</p>
<p>作用：①. 灾难时的数据恢复；②. MySQL的主从复制。在MySQL8版本中，默认二进制日志是开启着的，涉及到的参数如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">show variables like '<span class="token operator">%</span>log_bin<span class="token operator">%</span>'<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%971.jpg" alt="错误日志1"><br><img src="/images/%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%972.jpg" alt="错误日志2"><br>参数说明：</p>
<ul>
<li>log_bin_basename：当前数据库服务器的binlog日志的基础名称(前缀)，具体的binlog文件名需要再该basename的基础上加上编号(编号从000001开始)。</li>
<li>log_bin_index：binlog的索引文件，里面记录了当前服务器关联的binlog文件有哪些。</li>
</ul>
<h3 id="1-2-2-格式"><a href="#1-2-2-格式" class="headerlink" title="1.2.2 格式"></a>1.2.2 格式</h3><p>MySQL服务器中提供了多种格式来记录二进制日志，具体格式及特点如下：</p>
<table>
<thead>
<tr>
<th>日志各式</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>STATEMENT</td>
<td>基于SQL语句的日志记录，记录的是SQL语句，对数据进行修改的SQL都会记录在日志文件中。</td>
</tr>
<tr>
<td>ROW</td>
<td>基于行的日志记录，记录的是每一行的数据变更。（默认）</td>
</tr>
<tr>
<td>MIXED</td>
<td>混合了STATEMENT和ROW两种格式，默认采用STATEMENT，在某些特殊情况下会自动切换为ROW进行记录。</td>
</tr>
</tbody></table>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">show variables like '<span class="token operator">%</span>binlog_format<span class="token operator">%</span>'<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果我们需要配置二进制日志的格式，只需要在 /etc/my.cnf 中配置 binlog_format 参数即可。</p>
<h3 id="1-2-3-查看"><a href="#1-2-3-查看" class="headerlink" title="1.2.3 查看"></a>1.2.3 查看</h3><p>由于日志是以二进制方式存储的，不能直接读取，需要通过二进制日志查询工具 mysqlbinlog 来查看，具体语法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">mysqlbinlog <span class="token punctuation">[</span> 参数选项 <span class="token punctuation">]</span> logfilename
参数选项：
  <span class="token operator">-</span>d 指定数据库名称，只列出指定的数据库相关操作。
  <span class="token operator">-</span>o 忽略掉日志中的前n行命令。
  <span class="token operator">-</span>v 将行事件<span class="token punctuation">(</span>数据变更<span class="token punctuation">)</span>重构为SQL语句
  <span class="token operator">-</span>vv 将行事件<span class="token punctuation">(</span>数据变更<span class="token punctuation">)</span>重构为SQL语句，并输出注释信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-4-删除"><a href="#1-2-4-删除" class="headerlink" title="1.2.4 删除"></a>1.2.4 删除</h3><p>对于比较繁忙的业务系统，每天生成的binlog数据巨大，如果长时间不清除，将会占用大量磁盘空间。可以通过以下几种方式清理日志：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>reset master</td>
<td>删除全部 binlog 日志，删除之后，日志编号，将从 binlog.000001重新开始</td>
</tr>
<tr>
<td>purge master logs to ‘binlog.*’</td>
<td>删除 * 编号之前的所有日志</td>
</tr>
<tr>
<td>purge master logs before ‘yyyy-mm-dd hh24:mi:ss’</td>
<td>删除日志为 “yyyy-mm-dd hh24:mi:ss” 之前产生的所有日志</td>
</tr>
</tbody></table>
<p>也可以在mysql的配置文件中配置二进制日志的过期时间，设置了之后，二进制日志过期会自动删除。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">show variables like '<span class="token operator">%</span>binlog_expire_logs_seconds<span class="token operator">%</span>'<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-3-查询日志"><a href="#1-3-查询日志" class="headerlink" title="1.3 查询日志"></a>1.3 查询日志</h2><p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。默认情况下，查询日志是未开启的。<br><img src="/images/%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97.jpg" alt="查询日志"><br>如果需要开启查询日志，可以修改MySQL的配置文件 /etc/my.cnf 文件，添加如下内容：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#该选项用来开启查询日志 ， 可选值 ： <span class="token number">0</span> 或者 <span class="token number">1</span> ； <span class="token number">0</span> 代表关闭， <span class="token number">1</span> 代表开启
general_log<span class="token operator">=</span><span class="token number">1</span>
#设置日志的文件名 ， 如果没有指定， 默认的文件名为 host_name<span class="token punctuation">.</span>log
general_log_file<span class="token operator">=</span>mysql_query<span class="token punctuation">.</span>log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>开启了查询日志之后，在MySQL的数据存放目录，也就是 /var/lib/mysql/ 目录下就会出现mysql_query.log 文件。之后所有的客户端的增删改查操作都会记录在该日志文件之中，长时间运行后，该日志文件将会非常大。</p>
<h2 id="1-4-慢查询日志"><a href="#1-4-慢查询日志" class="headerlink" title="1.4 慢查询日志"></a>1.4 慢查询日志</h2><p>慢查询日志记录了所有执行时间超过参数 long_query_time 设置值并且扫描记录数不小于min_examined_row_limit 的所有的SQL语句的日志，默认未开启。long_query_time 默认为10 秒，最小为 0， 精度可以到微秒。</p>
<p>如果需要开启慢查询日志，需要在MySQL的配置文件 /etc/my.cnf 中配置如下参数：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#慢查询日志
slow_query_log<span class="token operator">=</span><span class="token number">1</span>
#执行时间参数
long_query_time<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认情况下，不会记录管理语句，也不会记录不使用索引进行查找的查询。可以使用log_slow_admin_statements和 更改此行为 log_queries_not_using_indexes，如下所述。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#记录执行较慢的管理语句
log_slow_admin_statements <span class="token operator">=</span><span class="token number">1</span>
#记录执行较慢的未使用索引的语句
log_queries_not_using_indexes <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述所有的参数配置完成之后，都需要重新启动MySQL服务器才可以生效。</p>
<h1 id="2-主从复制"><a href="#2-主从复制" class="headerlink" title="2. 主从复制"></a>2. 主从复制</h1><h2 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1 概述"></a>2.1 概述</h2><p>主从复制是指将主数据库的 DDL 和 DML 操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。</p>
<p>MySQL支持一台主库同时向多台从库进行复制， 从库同时也可以作为其他从服务器的主库，实现链状复制。<br><img src="/images/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.jpg" alt="主从复制"><br>MySQL 复制的优点主要包含以下三个方面：</p>
<ul>
<li>主库出现问题，可以快速切换到从库提供服务。</li>
<li>实现读写分离，降低主库的访问压力。</li>
<li>可以在从库中执行备份，以避免备份期间影响主库服务。</li>
</ul>
<h2 id="2-2-原理"><a href="#2-2-原理" class="headerlink" title="2.2 原理"></a>2.2 原理</h2><p>MySQL主从复制的核心就是 二进制日志，具体的过程如下：<br><img src="/images/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.jpg" alt="主从复制原理"><br>从上图来看，复制分成三步：</p>
<ol>
<li>Master 主库在事务提交时，会把数据变更记录在二进制日志文件 Binlog 中。</li>
<li>从库读取主库的二进制日志文件 Binlog ，写入到从库的中继日志 Relay Log 。</li>
<li>slave重做中继日志中的事件，将改变反映它自己的数据。</li>
</ol>
<h2 id="2-3-搭建"><a href="#2-3-搭建" class="headerlink" title="2.3 搭建"></a>2.3 搭建</h2><h3 id="2-3-1-准备"><a href="#2-3-1-准备" class="headerlink" title="2.3.1 准备"></a>2.3.1 准备</h3><p><img src="/images/%E6%90%AD%E5%BB%BA.jpg" alt="搭建"><br>准备好两台服务器之后，在上述的两台服务器中分别安装好MySQL，并完成基础的初始化准备(安装、密码配置等操作)工作。 其中：</p>
<ul>
<li>192.168.200.200 作为主服务器master</li>
<li>192.168.200.201 作为从服务器slave</li>
</ul>
<h3 id="2-3-2-主库配置"><a href="#2-3-2-主库配置" class="headerlink" title="2.3.2 主库配置"></a>2.3.2 主库配置</h3><ol>
<li>修改配置文件 /etc/my.cnf<pre class="line-numbers language-java" data-language="java"><code class="language-java">#mysql 服务ID，保证整个集群环境中唯一，取值范围：<span class="token number">1</span> – <span class="token number">232</span><span class="token operator">-</span><span class="token number">1</span>，默认为<span class="token number">1</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span>
#是否只读<span class="token punctuation">,</span><span class="token number">1</span> 代表只读<span class="token punctuation">,</span> <span class="token number">0</span> 代表读写
read<span class="token operator">-</span>only<span class="token operator">=</span><span class="token number">0</span>
#忽略的数据<span class="token punctuation">,</span> 指不需要同步的数据库
#binlog<span class="token operator">-</span>ignore<span class="token operator">-</span>db<span class="token operator">=</span>mysql
#指定同步的数据库
#binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db01<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>重启MySQL服务器<pre class="line-numbers language-java" data-language="java"><code class="language-java">systemctl restart mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>登录mysql，创建远程连接的账号，并授予主从复制权限<pre class="line-numbers language-java" data-language="java"><code class="language-java">#创建itcast用户，并设置密码，该用户可在任意主机连接该<span class="token class-name">MySQL</span>服务
CREATE USER <span class="token char">'itcast'</span>@<span class="token char">'%'</span> IDENTIFIED WITH mysql_native_password BY '<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">;</span>
#为 <span class="token char">'itcast'</span>@<span class="token char">'%'</span> 用户分配主从复制权限
GRANT REPLICATION SLAVE ON <span class="token operator">*</span><span class="token punctuation">.</span>* TO <span class="token char">'itcast'</span>@<span class="token char">'%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>通过指令，查看二进制日志坐标<pre class="line-numbers language-java" data-language="java"><code class="language-java">show master status <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="/images/%E6%9F%A5%E7%9C%8B%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97%E5%9D%90%E6%A0%87.jpg" alt="查看二进制日志坐标"><br>字段含义说明：</li>
</ol>
<ul>
<li>file : 从哪个日志文件开始推送日志文件</li>
<li>position ： 从哪个位置开始推送日志</li>
<li>binlog_ignore_db : 指定不需要同步的数据库</li>
</ul>
<h3 id="2-3-3-从库配置"><a href="#2-3-3-从库配置" class="headerlink" title="2.3.3 从库配置"></a>2.3.3 从库配置</h3><ol>
<li>修改配置文件 /etc/my.cnf<pre class="line-numbers language-java" data-language="java"><code class="language-java">#mysql 服务ID，保证整个集群环境中唯一，取值范围：<span class="token number">1</span> – <span class="token number">2</span><span class="token operator">^</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">1</span>，和主库不一样即可
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">2</span>
#是否只读<span class="token punctuation">,</span><span class="token number">1</span> 代表只读<span class="token punctuation">,</span> <span class="token number">0</span> 代表读写
read<span class="token operator">-</span>only<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>重新启动MySQL服务<pre class="line-numbers language-java" data-language="java"><code class="language-java">systemctl restart mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>登录mysql，设置主库配置<pre class="line-numbers language-java" data-language="java"><code class="language-java">CHANGE REPLICATION SOURCE <span class="token class-name">TO</span> SOURCE_HOST<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.200</span>'<span class="token punctuation">,</span> SOURCE_USER<span class="token operator">=</span><span class="token char">'itcast'</span><span class="token punctuation">,</span>SOURCE_PASSWORD<span class="token operator">=</span>'<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">,</span> SOURCE_LOG_FILE<span class="token operator">=</span>'binlog<span class="token punctuation">.</span><span class="token number">000004</span>'<span class="token punctuation">,</span>SOURCE_LOG_POS<span class="token operator">=</span><span class="token number">663</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
上述是8.0.23中的语法。如果mysql是 8.0.23 之前的版本，执行如下SQL：<pre class="line-numbers language-java" data-language="java"><code class="language-java">CHANGE MASTER <span class="token class-name">TO</span> MASTER_HOST<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.200</span>'<span class="token punctuation">,</span> MASTER_USER<span class="token operator">=</span><span class="token char">'itcast'</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span>'<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span>'binlog<span class="token punctuation">.</span><span class="token number">000004</span>'<span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">663</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<table>
<thead>
<tr>
<th>参数名</th>
<th>含义</th>
<th>8.0.23之前</th>
</tr>
</thead>
<tbody><tr>
<td>SOURCE_HOST</td>
<td>主库IP地址</td>
<td>MASTER_HOST</td>
</tr>
<tr>
<td>SOURCE_USER</td>
<td>连接主库的用户名</td>
<td>MASTER_USER</td>
</tr>
<tr>
<td>SOURCE_PASSWORD</td>
<td>连接主库的密码</td>
<td>MASTER_PASSWORD</td>
</tr>
<tr>
<td>SOURCE_LOG_FILE</td>
<td>binlog日志文件名</td>
<td>MASTER_LOG_FILE</td>
</tr>
<tr>
<td>SOURCE_LOG_POS</td>
<td>binlog日志文件位置</td>
<td>MASTER_LOG_POS</td>
</tr>
</tbody></table>
<ol start="4">
<li>开启同步操作</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">start replica <span class="token punctuation">;</span> #<span class="token number">8.0</span><span class="token number">.22</span>之后
start slave <span class="token punctuation">;</span> #<span class="token number">8.0</span><span class="token number">.22</span>之前<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol start="5">
<li>查看主从同步状态<pre class="line-numbers language-java" data-language="java"><code class="language-java">show replica status <span class="token punctuation">;</span> #<span class="token number">8.0</span><span class="token number">.22</span>之后
show slave status <span class="token punctuation">;</span> #<span class="token number">8.0</span><span class="token number">.22</span>之前<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<img src="/images/%E6%9F%A5%E7%9C%8B%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81.jpg" alt="查看主从同步状态"></li>
</ol>
<h1 id="3-分库分表"><a href="#3-分库分表" class="headerlink" title="3. 分库分表"></a>3. 分库分表</h1><h2 id="3-1-介绍"><a href="#3-1-介绍" class="headerlink" title="3.1 介绍"></a>3.1 介绍</h2><h3 id="3-1-1-问题分析"><a href="#3-1-1-问题分析" class="headerlink" title="3.1.1 问题分析"></a>3.1.1 问题分析</h3><p><img src="/images/%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90.jpg" alt="问题分析"><br>随着互联网及移动互联网的发展，应用系统的数据量也是成指数式增长，若采用单数据库进行数据存储，存在以下性能瓶颈：</p>
<ul>
<li><ol>
<li>IO瓶颈：热点数据太多，数据库缓存不足，产生大量磁盘IO，效率较低。 请求数据太多，带宽不够，网络IO瓶颈。</li>
</ol>
</li>
<li><ol start="2">
<li>CPU瓶颈：排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源，请求数太多，CPU出现瓶颈。</li>
</ol>
</li>
</ul>
<p>为了解决上述问题，我们需要对数据库进行分库分表处理。<br><img src="/images/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.jpg" alt="分库分表"><br>分库分表的中心思想都是将数据分散存储，使得单一数据库/表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。</p>
<h3 id="3-1-2-拆分策略"><a href="#3-1-2-拆分策略" class="headerlink" title="3.1.2 拆分策略"></a>3.1.2 拆分策略</h3><p>分库分表的形式，主要是两种：垂直拆分和水平拆分。而拆分的粒度，一般又分为分库和分表，所以组成的拆分策略最终如下：<br><img src="/images/%E6%8B%86%E5%88%86%E7%AD%96%E7%95%A5.jpg" alt="拆分策略"></p>
<h3 id="3-1-3-垂直拆分"><a href="#3-1-3-垂直拆分" class="headerlink" title="3.1.3 垂直拆分"></a>3.1.3 垂直拆分</h3><ol>
<li>垂直分库<br><img src="/images/%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93.jpg" alt="垂直分库"><br>垂直分库：以表为依据，根据业务将不同表拆分到不同库中。<br>特点：</li>
</ol>
<ul>
<li>每个库的表结构都不一样。</li>
<li>每个库的数据也不一样。</li>
<li>所有库的并集是全量数据。</li>
</ul>
<ol start="2">
<li>垂直分表<br><img src="/images/%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8.jpg" alt="垂直分表"><br>垂直分表：以字段为依据，根据字段属性将不同字段拆分到不同表中。<br>特点：</li>
</ol>
<ul>
<li>每个表的结构都不一样。</li>
<li>每个表的数据也不一样，一般通过一列（主键/外键）关联。</li>
<li>所有表的并集是全量数据。</li>
</ul>
<h3 id="3-1-4-水平拆分"><a href="#3-1-4-水平拆分" class="headerlink" title="3.1.4 水平拆分"></a>3.1.4 水平拆分</h3><ol>
<li>水平分库<br><img src="/images/%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93.jpg" alt="水平分库"><br>水平分库：以字段为依据，按照一定策略，将一个库的数据拆分到多个库中。<br>特点：</li>
</ol>
<ul>
<li>每个库的表结构都一样。</li>
<li>每个库的数据都不一样。</li>
<li>所有库的并集是全量数据。</li>
</ul>
<ol start="2">
<li>水平分表<br><img src="/images/%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8.jpg" alt="水平分表"><br>水平分表：以字段为依据，按照一定策略，将一个表的数据拆分到多个表中。<br>特点：</li>
</ol>
<ul>
<li>每个表的表结构都一样。</li>
<li>每个表的数据都不一样。</li>
<li>所有表的并集是全量数据。<br>在业务系统中，为了缓解磁盘IO及CPU的性能瓶颈，到底是垂直拆分，还是水平拆分；具体是分库，还是分表，都需要根据具体的业务需求具体分析。</li>
</ul>
<h3 id="3-1-5-实现技术"><a href="#3-1-5-实现技术" class="headerlink" title="3.1.5 实现技术"></a>3.1.5 实现技术</h3><ul>
<li>shardingJDBC：基于AOP原理，在应用程序中对本地执行的SQL进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持java语言，性能较高。</li>
<li>MyCat：数据库分库分表中间件，不用调整代码即可实现分库分表，支持多种语言，性能不及前者。<br><img src="/images/%E5%AE%9E%E7%8E%B0%E6%8A%80%E6%9C%AF.jpg" alt="实现技术"><br>本次课程，我们选择了是MyCat数据库中间件，通过MyCat中间件来完成分库分表操作。</li>
</ul>
<h2 id="3-2-MyCat概述"><a href="#3-2-MyCat概述" class="headerlink" title="3.2 MyCat概述"></a>3.2 MyCat概述</h2><h3 id="3-2-1-介绍"><a href="#3-2-1-介绍" class="headerlink" title="3.2.1 介绍"></a>3.2.1 介绍</h3><p>Mycat是开源的、活跃的、基于Java语言编写的MySQL数据库中间件。可以像使用mysql一样来使用mycat，对于开发人员来说根本感觉不到mycat的存在。<br>开发人员只需要连接MyCat即可，而具体底层用到几台数据库，每一台数据库服务器里面存储了什么数据，都无需关心。 具体的分库分表的策略，只需要在MyCat中配置即可。<br><img src="/images/MyCat%E6%A6%82%E8%BF%B0.jpg" alt="MyCat概述"><br>优势：</p>
<ul>
<li>性能可靠稳定</li>
<li>强大的技术团队</li>
<li>体系完善</li>
<li>社区活跃</li>
</ul>
<h3 id="3-2-2-下载"><a href="#3-2-2-下载" class="headerlink" title="3.2.2 下载"></a>3.2.2 下载</h3><p>下载地址： <a target="_blank" rel="noopener" href="http://dl.mycat.org.cn/">http://dl.mycat.org.cn/</a><br><img src="/images/MyCat.jpg" alt="MyCat"></p>
<h3 id="3-2-3-安装"><a href="#3-2-3-安装" class="headerlink" title="3.2.3 安装"></a>3.2.3 安装</h3><p>Mycat是采用java语言开发的开源的数据库中间件，支持Windows和Linux运行环境，下面介绍MyCat的Linux中的环境搭建。我们需要在准备好的服务器中安装如下软件。</p>
<ul>
<li><p>MySQL</p>
</li>
<li><p>JDK</p>
</li>
<li><p>Mycat</p>
<table>
<thead>
<tr>
<th>服务器</th>
<th>安装软件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.200.210</td>
<td>JDK、Mycat</td>
<td>MyCat中间件服务器</td>
</tr>
<tr>
<td>192.168.200.210</td>
<td>MySQL</td>
<td>分片服务器</td>
</tr>
<tr>
<td>192.168.200.213</td>
<td>MySQL</td>
<td>分片服务器</td>
</tr>
<tr>
<td>192.168.200.214</td>
<td>MySQL</td>
<td>分片服务器</td>
</tr>
</tbody></table>
</li>
</ul>
<p>具体的安装步骤： 参考资料中提供的 《MyCat安装文档》即可，里面有详细的安装及配置步骤。</p>
<h3 id="3-2-4-目录介绍"><a href="#3-2-4-目录介绍" class="headerlink" title="3.2.4 目录介绍"></a>3.2.4 目录介绍</h3><p><img src="/images/%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D.jpg" alt="目录介绍"><br>bin : 存放可执行文件，用于启动停止mycat<br>conf：存放mycat的配置文件<br>lib：存放mycat的项目依赖包（jar）<br>logs：存放mycat的日志文件</p>
<h3 id="3-2-5-概念介绍"><a href="#3-2-5-概念介绍" class="headerlink" title="3.2.5 概念介绍"></a>3.2.5 概念介绍</h3><p>在MyCat的整体结构中，分为两个部分：上面的逻辑结构、下面的物理结构。<br><img src="/images/MyCat%E7%9A%84%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.jpg" alt="MyCat的整体结构"><br>在MyCat的逻辑结构主要负责逻辑库、逻辑表、分片规则、分片节点等逻辑结构的处理，而具体的数据存储还是在物理结构，也就是数据库服务器中存储的。</p>
<p>在后面讲解MyCat入门以及MyCat分片时，还会讲到上面所提到的概念。</p>
<h2 id="3-3-MyCat入门"><a href="#3-3-MyCat入门" class="headerlink" title="3.3 MyCat入门"></a>3.3 MyCat入门</h2><h3 id="3-3-1-需求"><a href="#3-3-1-需求" class="headerlink" title="3.3.1 需求"></a>3.3.1 需求</h3><p>由于 tb_order 表中数据量很大，磁盘IO及容量都到达了瓶颈，现在需要对 tb_order 表进行数据分片，分为三个数据节点，每一个节点主机位于不同的服务器上, 具体的结构，参考下图：<br><img src="/images/MyCat%E5%85%A5%E9%97%A8.jpg" alt="MyCat入门"></p>
<h3 id="3-3-2-环境准备"><a href="#3-3-2-环境准备" class="headerlink" title="3.3.2 环境准备"></a>3.3.2 环境准备</h3><p>准备3台服务器：</p>
<ul>
<li>192.168.200.210：MyCat中间件服务器，同时也是第一个分片服务器。</li>
<li>192.168.200.213：第二个分片服务器。</li>
<li>192.168.200.214：第三个分片服务器。<br><img src="/images/%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.jpg" alt="环境准备"><br>并且在上述3台数据库中创建数据库 db01 。</li>
</ul>
<h3 id="3-3-3-配置"><a href="#3-3-3-配置" class="headerlink" title="3.3.3 配置"></a>3.3.3 配置</h3><p>1). schema.xml<br>在schema.xml中配置逻辑库、逻辑表、数据节点、节点主机等相关信息。具体的配置如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE mycat<span class="token operator">:</span>schema SYSTEM <span class="token string">"schema.dtd"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>mycat<span class="token operator">:</span>schema xmlns<span class="token operator">:</span>mycat<span class="token operator">=</span><span class="token string">"http://io.mycat/"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"DB01"</span> checkSQLschema<span class="token operator">=</span><span class="token string">"true"</span> sqlMaxLimit<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1,dn2,dn3"</span> rule<span class="token operator">=</span><span class="token string">"auto-sharding-long"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn1"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn2"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn3"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost1"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"0"</span>
writeType<span class="token operator">=</span><span class="token string">"0"</span> dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span>
slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost2"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"0"</span>writeType<span class="token operator">=</span><span class="token string">"0"</span> dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span>slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.213:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>
user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost3"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"0"</span>
writeType<span class="token operator">=</span><span class="token string">"0"</span> dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span>
slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.214:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>mycat<span class="token operator">:</span>schema<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2). server.xml<br>需要在server.xml中配置用户名、密码，以及用户的访问权限信息，具体的配置如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"root"</span> defaultAccount<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>DB01<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 表级 DML 权限设置 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
<span class="token operator">&lt;</span>privileges check<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"DB01"</span> dml<span class="token operator">=</span><span class="token string">"0110"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dml<span class="token operator">=</span><span class="token string">"1110"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>privileges<span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"user"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>DB01<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"readOnly"</span><span class="token operator">&gt;</span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述的配置表示，定义了两个用户 root 和 user ，这两个用户都可以访问 DB01 这个逻辑库，访问密码都是123456，但是root用户访问DB01逻辑库，既可以读，又可以写，但是 user用户访问DB01逻辑库是只读的。</p>
<h3 id="3-3-4-测试"><a href="#3-3-4-测试" class="headerlink" title="3.3.4 测试"></a>3.3.4 测试</h3><h4 id="3-3-4-1-启动"><a href="#3-3-4-1-启动" class="headerlink" title="3.3.4.1 启动"></a>3.3.4.1 启动</h4><p>配置完毕后，先启动涉及到的3台分片服务器，然后启动MyCat服务器。切换到Mycat的安装目录，执行如下指令，启动Mycat：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#启动
bin<span class="token operator">/</span>mycat start
#停止
bin<span class="token operator">/</span>mycat stop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Mycat启动之后，占用端口号 8066。<br>启动完毕之后，可以查看logs目录下的启动日志，查看Mycat是否启动完成。<br><img src="/images/%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97.jpg" alt="启动日志"></p>
<h4 id="3-3-4-2-测试"><a href="#3-3-4-2-测试" class="headerlink" title="3.3.4.2 测试"></a>3.3.4.2 测试</h4><p>1). 连接MyCat<br>通过如下指令，就可以连接并登陆MyCat。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">mysql <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.210</span> <span class="token operator">-</span><span class="token class-name">P</span> <span class="token number">8066</span> <span class="token operator">-</span>uroot <span class="token operator">-</span>p123456<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们看到我们是通过MySQL的指令来连接的MyCat，因为MyCat在底层实际上是模拟了MySQL的协议。</p>
<p>2). 数据测试<br>然后就可以在MyCat中来创建表，并往表结构中插入数据，查看数据在MySQL中的分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CREATE <span class="token class-name">TABLE</span> TB_ORDER <span class="token punctuation">(</span>
id <span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL<span class="token punctuation">,</span>
title <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token class-name">NOT</span> NULL <span class="token punctuation">,</span>
<span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span>INNODB <span class="token class-name">DEFAULT</span> CHARSET<span class="token operator">=</span>utf8 <span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'goods1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token char">'goods2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'goods3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'goods1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token char">'goods2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'goods3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">5000000</span><span class="token punctuation">,</span>'goods5000000'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">,</span>'goods10000000'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">10000001</span><span class="token punctuation">,</span>'goods10000001'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">15000000</span><span class="token punctuation">,</span>'goods15000000'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> <span class="token function">TB_ORDER</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>title<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token number">15000001</span><span class="token punctuation">,</span>'goods15000001'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过测试，我们发现，在往 TB_ORDER 表中插入数据时：</p>
<ul>
<li>如果id的值在1-500w之间，数据将会存储在第一个分片数据库中。</li>
<li>如果id的值在500w-1000w之间，数据将会存储在第二个分片数据库中。</li>
<li>如果id的值在1000w-1500w之间，数据将会存储在第三个分片数据库中。</li>
<li>如果id的值超出1500w，在插入数据时，将会报错。<br>为什么会出现这种现象，数据到底落在哪一个分片服务器到底是如何决定的呢？ 这是由逻辑表配置时的一个参数 rule 决定的，而这个参数配置的就是分片规则，关于分片规则的配置，在后面的课程中会详细讲解。</li>
</ul>
<h2 id="3-4-MyCat配置"><a href="#3-4-MyCat配置" class="headerlink" title="3.4 MyCat配置"></a>3.4 MyCat配置</h2><h3 id="3-4-1-schema-xml"><a href="#3-4-1-schema-xml" class="headerlink" title="3.4.1 schema.xml"></a>3.4.1 schema.xml</h3><p>schema.xml 作为MyCat中最重要的配置文件之一 , 涵盖了MyCat的逻辑库 、 逻辑表 、 分片规则、分片节点及数据源的配置。<br><img src="/images/MyCat%E9%85%8D%E7%BD%AE.jpg" alt="MyCat配置"><br>主要包含以下三组标签：</p>
<ul>
<li>schema标签</li>
<li>datanode标签</li>
<li>datahost标签</li>
</ul>
<h4 id="3-4-1-1-schema标签"><a href="#3-4-1-1-schema标签" class="headerlink" title="3.4.1.1 schema标签"></a>3.4.1.1 schema标签</h4><p>1). schema 定义逻辑库<br><img src="/images/%E5%AE%9A%E4%B9%89%E9%80%BB%E8%BE%91%E5%BA%93.jpg" alt="定义逻辑库"><br>schema 标签用于定义 MyCat实例中的逻辑库 , 一个MyCat实例中, 可以有多个逻辑库 , 可以通过 schema 标签来划分不同的逻辑库。MyCat中的逻辑库的概念，等同于MySQL中的database概念, 需要操作某个逻辑库下的表时, 也需要切换逻辑库(use xxx)。</p>
<p>核心属性：</p>
<ul>
<li>name：指定自定义的逻辑库库名</li>
<li>checkSQLschema：在SQL语句操作时指定了数据库名称，执行时是否自动去除；true：自动去除，false：不自动去除</li>
<li>sqlMaxLimit：如果未指定limit进行查询，列表查询模式查询多少条记录</li>
</ul>
<p>2). schema 中的table定义逻辑表<br><img src="/images/%E5%AE%9A%E4%B9%89%E9%80%BB%E8%BE%91%E8%A1%A8.jpg" alt="定义逻辑表"><br>table 标签定义了MyCat中逻辑库schema下的逻辑表 , 所有需要拆分的表都需要在table标签中定义 。</p>
<p>核心属性：</p>
<ul>
<li>name：定义逻辑表表名，在该逻辑库下唯一</li>
<li>dataNode：定义逻辑表所属的dataNode，该属性需要与dataNode标签中name对应；多个dataNode逗号分隔</li>
<li>rule：分片规则的名字，分片规则名字是在rule.xml中定义的</li>
<li>primaryKey：逻辑表对应真实表的主键</li>
<li>type：逻辑表的类型，目前逻辑表只有全局表和普通表，如果未配置，就是普通表；全局表，配置为 global</li>
</ul>
<h4 id="3-4-1-2-datanode标签"><a href="#3-4-1-2-datanode标签" class="headerlink" title="3.4.1.2 datanode标签"></a>3.4.1.2 datanode标签</h4><p><img src="/images/datanode%E6%A0%87%E7%AD%BE.jpg" alt="datanode标签"></p>
<p>核心属性：</p>
<ul>
<li>name：定义数据节点名称</li>
<li>dataHost：数据库实例主机名称，引用自 dataHost 标签中name属性</li>
<li>database：定义分片所属数据库</li>
</ul>
<h4 id="3-4-1-3-datahost标签"><a href="#3-4-1-3-datahost标签" class="headerlink" title="3.4.1.3 datahost标签"></a>3.4.1.3 datahost标签</h4><p><img src="/images/datahost%E6%A0%87%E7%AD%BE.jpg" alt="datahost标签"><br>该标签在MyCat逻辑库中作为底层标签存在, 直接定义了具体的数据库实例、读写分离、心跳语句。<br>核心属性：</p>
<ul>
<li>name：唯一标识，供上层标签使用</li>
<li>maxCon/minCon：最大连接数/最小连接数</li>
<li>balance：负载均衡策略，取值 0,1,2,3</li>
<li>writeType：写操作分发方式（0：写操作转发到第一个writeHost，第一个挂了，切换到第二个；1：写操作随机分发到配置的writeHost）</li>
<li>dbDriver：数据库驱动，支持 native、jdbc</li>
</ul>
<h3 id="3-4-2-rule-xml"><a href="#3-4-2-rule-xml" class="headerlink" title="3.4.2 rule.xml"></a>3.4.2 rule.xml</h3><p>rule.xml中定义所有拆分表的规则, 在使用过程中可以灵活的使用分片算法, 或者对同一个分片算法使用不同的参数, 它让分片过程可配置化。主要包含两类标签：tableRule、Function。<br><img src="/images/rule.jpg" alt="rule"></p>
<h3 id="3-4-3-server-xml"><a href="#3-4-3-server-xml" class="headerlink" title="3.4.3 server.xml"></a>3.4.3 server.xml</h3><p>server.xml配置文件包含了MyCat的系统配置信息，主要有两个重要的标签：system、user。1). system标签<br>1). system标签<br><img src="/images/system%E6%A0%87%E7%AD%BE.jpg" alt="system标签"><br>主要配置MyCat中的系统配置信息，对应的系统配置项及其含义，如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>取值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>charset</td>
<td>utf8</td>
<td>设置Mycat的字符集, 字符集需要与MySQL的字符集保持一致</td>
</tr>
<tr>
<td>nonePasswordLogin</td>
<td>0,1</td>
<td>0为需要密码登陆、1为不需要密码登陆 ,默认为0，设置为1则需要指定默认账户</td>
</tr>
<tr>
<td>useHandshakeV10</td>
<td>0,1</td>
<td>使用该选项主要的目的是为了能够兼容高版本的jdbc驱动, 是否采用 HandshakeV10Packet来与client进行通信, 1:是, 0:否</td>
</tr>
<tr>
<td>useSqlStat</td>
<td>0,1</td>
<td>开启SQL实时统计, 1 为开启 , 0 为关闭 ;开启之后, MyCat会自动统计SQL语句的执行情况 ; mysql -h 127.0.0.1 -P 9066-u root -p 查看MyCat执行的SQL, 执行效率比较低的SQL , SQL的整体执行情况、读写比例等 ; show @@sql ; show@@sql.slow ; show @@sql.sum ;</td>
</tr>
<tr>
<td>useGlobleTableCheck</td>
<td>0,1</td>
<td>是否开启全局表的一致性检测。1为开启 ，0为关闭 。</td>
</tr>
<tr>
<td>sqlExecuteTimeout</td>
<td>1000</td>
<td>SQL语句执行的超时时间 , 单位为 s ;</td>
</tr>
<tr>
<td>sequnceHandlerType</td>
<td>0,1,2</td>
<td>用来指定Mycat全局序列类型，0 为本地文件，1 为数据库方式，2 为时间戳列方式，默认使用本地文件方式，文件方式主要用于测试</td>
</tr>
<tr>
<td>sequnceHandlerPattern</td>
<td>正则表达式</td>
<td>必须带有MYCATSEQ或者 mycatseq进入序列匹配流程 注意MYCATSEQ_有空格的情况</td>
</tr>
<tr>
<td>subqueryRelationshipCheck</td>
<td>true,false</td>
<td>子查询中存在关联查询的情况下,检查关联字段中是否有分片字段 .默认 false</td>
</tr>
<tr>
<td>useCompression</td>
<td>0,1</td>
<td>开启mysql压缩协议 , 0 : 关闭, 1 : 开启</td>
</tr>
<tr>
<td>fakeMySQLVersion</td>
<td>5.5,5.6</td>
<td>设置模拟的MySQL版本号</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>属性</th>
<th>取值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>defaultSqlParser</td>
<td></td>
<td>由于MyCat的最初版本使用了FoundationDB的SQL解析器, 在MyCat1.3后增加了Druid解析器, 所以要设置defaultSqlParser属性来指定默认的解析器; 解析器有两个 :druidparser 和 fdbparser, 在MyCat1.4之后,默认是druidparser,fdbparser已经废除了</td>
</tr>
<tr>
<td>processors</td>
<td>1,2….</td>
<td>指定系统可用的线程数量, 默认值为CPU核心x 每个核心运行线程数量; processors 会影响processorBufferPool,processorBufferLocalPercent,processorExecutor属性, 所有, 在性能调优时, 可以适当地修改processors值</td>
</tr>
<tr>
<td>processorBufferChunk</td>
<td></td>
<td>指定每次分配Socket Direct Buffer默认值为4096字节, 也会影响BufferPool长度,如果一次性获取字节过多而导致buffer不够用, 则会出现警告, 可以调大该值</td>
</tr>
<tr>
<td>processorExecutor</td>
<td></td>
<td>指定NIOProcessor上共享businessExecutor固定线程池的大小;MyCat把异步任务交给 businessExecutor线程池中, 在新版本的MyCat中这个连接池使用频次不高, 可以适当地把该值调小</td>
</tr>
<tr>
<td>packetHeaderSize</td>
<td></td>
<td>指定MySQL协议中的报文头长度, 默认4个字节</td>
</tr>
<tr>
<td>maxPacketSize</td>
<td></td>
<td>指定MySQL协议可以携带的数据最大大小, 默认值为16M</td>
</tr>
<tr>
<td>idleTimeout</td>
<td>30</td>
<td>指定连接的空闲时间的超时长度;如果超时,将关闭资源并回收, 默认30分钟</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>属性</th>
<th>取值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>txIsolation</td>
<td>1,2,3,4</td>
<td>初始化前端连接的事务隔离级别,默认为REPEATED_READ , 对应数字为3READ_UNCOMMITED=1;READ_COMMITTED=2; REPEATED_READ=3;SERIALIZABLE=4;</td>
</tr>
<tr>
<td>sqlExecuteTimeout</td>
<td>300</td>
<td>执行SQL的超时时间, 如果SQL语句执行超时,将关闭连接; 默认300秒;</td>
</tr>
<tr>
<td>serverPort</td>
<td>8066</td>
<td>定义MyCat的使用端口, 默认8066</td>
</tr>
<tr>
<td>managerPort</td>
<td>9066</td>
<td>定义MyCat的管理端口, 默认9066</td>
</tr>
</tbody></table>
<p>2). user标签<br>配置MyCat中的用户、访问密码，以及用户针对于逻辑库、逻辑表的权限信息，具体的权限描述方式及配置说明如下：<br><img src="/images/user%E6%A0%87%E7%AD%BE.jpg" alt="user标签"><br>在测试权限操作时，我们只需要将 privileges 标签的注释放开。 在 privileges 下的schema标签中配置的dml属性配置的是逻辑库的权限。 在privileges的schema下的table标签的dml属性中配置逻辑表的权限。</p>
<h2 id="3-5-MyCat分片"><a href="#3-5-MyCat分片" class="headerlink" title="3.5 MyCat分片"></a>3.5 MyCat分片</h2><h3 id="3-5-1-垂直拆分"><a href="#3-5-1-垂直拆分" class="headerlink" title="3.5.1 垂直拆分"></a>3.5.1 垂直拆分</h3><h4 id="3-5-1-1-场景"><a href="#3-5-1-1-场景" class="headerlink" title="3.5.1.1 场景"></a>3.5.1.1 场景</h4><p>在业务系统中, 涉及以下表结构 ,但是由于用户与订单每天都会产生大量的数据, 单台服务器的数据存储及处理能力是有限的, 可以对数据库表进行拆分, 原有的数据库表如下。<br><img src="/images/%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86.jpg" alt="垂直拆分"><br>现在考虑将其进行垂直分库操作，将商品相关的表拆分到一个数据库服务器，订单表拆分的一个数据库服务器，用户及省市区表拆分到一个服务器。最终结构如下：<br><img src="/images/%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93%E6%93%8D%E4%BD%9C.jpg" alt="垂直分库操作"></p>
<h4 id="3-5-1-2-准备"><a href="#3-5-1-2-准备" class="headerlink" title="3.5.1.2 准备"></a>3.5.1.2 准备</h4><p>准备三台服务器，IP地址如图所示：<br><img src="/images/%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%931.jpg" alt="垂直分库1"><br>并且在192.168.200.210，192.168.200.213, 192.168.200.214上面创建数据库shopping。</p>
<h4 id="3-5-1-3-配置"><a href="#3-5-1-3-配置" class="headerlink" title="3.5.1.3 配置"></a>3.5.1.3 配置</h4><p>1). schema.xml</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"SHOPPING"</span> checkSQLschema<span class="token operator">=</span><span class="token string">"true"</span> sqlMaxLimit<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_goods_base"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_goods_brand"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_goods_cat"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_goods_desc"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1"</span> primaryKey<span class="token operator">=</span><span class="token string">"goods_id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_goods_item"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_order_item"</span> dataNode<span class="token operator">=</span><span class="token string">"dn2"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_order_master"</span> dataNode<span class="token operator">=</span><span class="token string">"dn2"</span> primaryKey<span class="token operator">=</span><span class="token string">"order_id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_order_pay_log"</span> dataNode<span class="token operator">=</span><span class="token string">"dn2"</span> primaryKey<span class="token operator">=</span><span class="token string">"out_trade_no"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_user"</span> dataNode<span class="token operator">=</span><span class="token string">"dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_user_address"</span> dataNode<span class="token operator">=</span><span class="token string">"dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_areas_provinces"</span> dataNode<span class="token operator">=</span><span class="token string">"dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_areas_city"</span> dataNode<span class="token operator">=</span><span class="token string">"dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_areas_region"</span> dataNode<span class="token operator">=</span><span class="token string">"dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn1"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"shopping"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn2"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"shopping"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn3"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"shopping"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost1"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"0"</span>
writeType<span class="token operator">=</span><span class="token string">"0"</span> dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span>
slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost2"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"0"</span>
writeType<span class="token operator">=</span><span class="token string">"0"</span> dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span>
slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.213:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost3"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"0"</span>
writeType<span class="token operator">=</span><span class="token string">"0"</span> dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span>
slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.214:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2). server.xml</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"root"</span> defaultAccount<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>SHOPPING<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 表级 DML 权限设置 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
<span class="token operator">&lt;</span>privileges check<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"DB01"</span> dml<span class="token operator">=</span><span class="token string">"0110"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dml<span class="token operator">=</span><span class="token string">"1110"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>privileges<span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"user"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>SHOPPING<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"readOnly"</span><span class="token operator">&gt;</span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-1-4-测试"><a href="#3-5-1-4-测试" class="headerlink" title="3.5.1.4 测试"></a>3.5.1.4 测试</h4><p>1). 上传测试SQL脚本到服务器的/root目录<br><img src="/images/%E4%B8%8A%E4%BC%A0%E6%B5%8B%E8%AF%95.jpg" alt="上传测试"><br>2). 执行指令导入测试数据<br>重新启动MyCat后，在mycat的命令行中，通过source指令导入表结构，以及对应的数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">source <span class="token operator">/</span>root<span class="token operator">/</span>shopping<span class="token operator">-</span>table<span class="token punctuation">.</span>sql
source <span class="token operator">/</span>root<span class="token operator">/</span>shopping<span class="token operator">-</span>insert<span class="token punctuation">.</span>sql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>将表结构及对应的测试数据导入之后，可以检查一下各个数据库服务器中的表结构分布情况。 检查是否和我们准备工作中规划的服务器一致。<br><img src="/images/%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.jpg" alt="测试数据"><br>3). 查询用户的收件人及收件人地址信息(包含省、市、区)。<br>在MyCat的命令行中，当我们执行以下多表联查的SQL语句时，可以正常查询出数据。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">select ua<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> ua<span class="token punctuation">.</span>contact<span class="token punctuation">,</span> p<span class="token punctuation">.</span>province<span class="token punctuation">,</span> c<span class="token punctuation">.</span>city<span class="token punctuation">,</span> r<span class="token punctuation">.</span>area <span class="token punctuation">,</span> ua<span class="token punctuation">.</span>address fromtb_user_address ua <span class="token punctuation">,</span>tb_areas_city c <span class="token punctuation">,</span> tb_areas_provinces p <span class="token punctuation">,</span>tb_areas_region rwhere ua<span class="token punctuation">.</span>province_id <span class="token operator">=</span> p<span class="token punctuation">.</span>provinceid and ua<span class="token punctuation">.</span>city_id <span class="token operator">=</span> c<span class="token punctuation">.</span>cityid and ua<span class="token punctuation">.</span>town_id <span class="token operator">=</span>r<span class="token punctuation">.</span>areaid <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E6%9F%A5%E8%AF%A2%E5%87%BA%E6%95%B0%E6%8D%AE.jpg" alt="查询出数据"><br>4). 查询每一笔订单及订单的收件地址信息(包含省、市、区)。<br>实现该需求对应的SQL语句如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SELECT</span> order_id <span class="token punctuation">,</span> payment <span class="token punctuation">,</span>receiver<span class="token punctuation">,</span> province <span class="token punctuation">,</span> city <span class="token punctuation">,</span> area FROM tb_order_master o<span class="token punctuation">,</span> tb_areas_provinces p <span class="token punctuation">,</span> tb_areas_city c <span class="token punctuation">,</span> tb_areas_region r <span class="token class-name">WHEREo</span><span class="token punctuation">.</span>receiver_province <span class="token operator">=</span> p<span class="token punctuation">.</span>provinceid AND o<span class="token punctuation">.</span>receiver_city <span class="token operator">=</span> c<span class="token punctuation">.</span>cityid <span class="token class-name">ANDo</span><span class="token punctuation">.</span>receiver_region <span class="token operator">=</span> r<span class="token punctuation">.</span>areaid <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但是现在存在一个问题，订单相关的表结构是在 192.168.200.213 数据库服务器中，而省市区的数据库表是在 192.168.200.214 数据库服务器中。那么在MyCat中执行是否可以成功呢？<br><img src="/images/%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E7%9A%84%E8%A1%A8.jpg" alt="订单相关的表"><br>经过测试，我们看到，SQL语句执行报错。原因就是因为MyCat在执行该SQL语句时，需要往具体的数据库服务器中路由，而当前没有一个数据库服务器完全包含了订单以及省市区的表结构，造成SQL语句失败，报错。<br>对于上述的这种现象，我们如何来解决呢？ 下面我们介绍的全局表，就可以轻松解决这个问题。</p>
<h4 id="3-5-1-5-全局表"><a href="#3-5-1-5-全局表" class="headerlink" title="3.5.1.5 全局表"></a>3.5.1.5 全局表</h4><p>对于省、市、区/县表tb_areas_provinces , tb_areas_city , tb_areas_region，是属于数据字典表，在多个业务模块中都可能会遇到，可以将其设置为全局表，利于业务操作。<br>修改schema.xml中的逻辑表的配置，修改 tb_areas_provinces、tb_areas_city、tb_areas_region 三个逻辑表，增加 type 属性，配置为global，就代表该表是全局表，就会在所涉及到的dataNode中创建给表。对于当前配置来说，也就意味着所有的节点中都有该表了。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_areas_provinces"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1,dn2,dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> type<span class="token operator">=</span><span class="token string">"global"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_areas_city"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1,dn2,dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> type<span class="token operator">=</span><span class="token string">"global"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_areas_region"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1,dn2,dn3"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> type<span class="token operator">=</span><span class="token string">"global"</span><span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/%E5%85%A8%E5%B1%80%E8%A1%A8.jpg" alt="全局表"><br>配置完毕后，重新启动MyCat。<br>1). 删除原来每一个数据库服务器中的所有表结构<br>2). 通过source指令，导入表及数据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">source <span class="token operator">/</span>root<span class="token operator">/</span>shopping<span class="token operator">-</span>table<span class="token punctuation">.</span>sql
source <span class="token operator">/</span>root<span class="token operator">/</span>shopping<span class="token operator">-</span>insert<span class="token punctuation">.</span>sql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>3). 检查每一个数据库服务器中的表及数据分布，看到三个节点中都有这三张全局表<br>4). 然后再次执行上面的多表联查的SQL语句</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SELECT</span> order_id <span class="token punctuation">,</span> payment <span class="token punctuation">,</span>receiver<span class="token punctuation">,</span> province <span class="token punctuation">,</span> city <span class="token punctuation">,</span> area FROM tb_order_master o<span class="token punctuation">,</span> tb_areas_provinces p <span class="token punctuation">,</span> tb_areas_city c <span class="token punctuation">,</span> tb_areas_region r WHERE o<span class="token punctuation">.</span>receiver_province <span class="token operator">=</span> p<span class="token punctuation">.</span>provinceid AND o<span class="token punctuation">.</span>receiver_city <span class="token operator">=</span> c<span class="token punctuation">.</span>cityid <span class="token class-name">ANDo</span><span class="token punctuation">.</span>receiver_region <span class="token operator">=</span> r<span class="token punctuation">.</span>areaid <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8MyCat.jpg" alt="重新启动MyCat"><br>是可以正常执行成功的。<br>5). 当在MyCat中更新全局表的时候，我们可以看到，所有分片节点中的数据都发生了变化，每个节点的全局表数据时刻保持一致。</p>
<h3 id="3-5-2-水平拆分"><a href="#3-5-2-水平拆分" class="headerlink" title="3.5.2 水平拆分"></a>3.5.2 水平拆分</h3><h4 id="3-5-2-1-场景"><a href="#3-5-2-1-场景" class="headerlink" title="3.5.2.1 场景"></a>3.5.2.1 场景</h4><p>在业务系统中, 有一张表(日志表), 业务系统每天都会产生大量的日志数据 , 单台服务器的数据存储及处理能力是有限的, 可以对数据库表进行拆分。<br><img src="/images/%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86.jpg" alt="水平拆分"></p>
<h4 id="3-5-2-2-准备"><a href="#3-5-2-2-准备" class="headerlink" title="3.5.2.2 准备"></a>3.5.2.2 准备</h4><p>准备三台服务器，具体的结构如下：<br><img src="/images/%E5%87%86%E5%A4%87%E4%B8%89%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8.jpg" alt="准备三台服务器"><br>并且，在三台数据库服务器中分表创建一个数据库itcast。</p>
<h4 id="3-5-2-3-配置"><a href="#3-5-2-3-配置" class="headerlink" title="3.5.2.3 配置"></a>3.5.2.3 配置</h4><p>1). schema.xml</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"ITCAST"</span> checkSQLschema<span class="token operator">=</span><span class="token string">"true"</span> sqlMaxLimit<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_log"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> rule<span class="token operator">=</span><span class="token string">"mod-long"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>tb_log表最终落在3个节点中，分别是 dn4、dn5、dn6 ，而具体的数据分别存储在 dhost1、dhost2、dhost3的itcast数据库中。</p>
<p>2). server.xml<br>配置root用户既可以访问 SHOPPING 逻辑库，又可以访问ITCAST逻辑库。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"root"</span> defaultAccount<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>SHOPPING<span class="token punctuation">,</span>ITCAST<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 表级 DML 权限设置 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
<span class="token operator">&lt;</span>privileges check<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"DB01"</span> dml<span class="token operator">=</span><span class="token string">"0110"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dml<span class="token operator">=</span><span class="token string">"1110"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>privileges<span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-2-4-测试"><a href="#3-5-2-4-测试" class="headerlink" title="3.5.2.4 测试"></a>3.5.2.4 测试</h4><p>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CREATE <span class="token class-name">TABLE</span> tb_log <span class="token punctuation">(</span>
id <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token char">'ID'</span><span class="token punctuation">,</span>
model_name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'模块名'</span><span class="token punctuation">,</span>
model_value <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'模块值'</span><span class="token punctuation">,</span>
return_value <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'返回值'</span><span class="token punctuation">,</span>
return_class <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'返回值类型'</span><span class="token punctuation">,</span>
operate_user <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'操作用户'</span><span class="token punctuation">,</span>
operate_time <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'操作时间'</span><span class="token punctuation">,</span>
param_and_value <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT '请求参数名及参数值'<span class="token punctuation">,</span>
operate_class <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'操作类'</span><span class="token punctuation">,</span>
operate_method <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'操作方法'</span><span class="token punctuation">,</span>
cost_time <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT '执行方法耗时<span class="token punctuation">,</span> 单位 ms'<span class="token punctuation">,</span>
source <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT '来源 <span class="token operator">:</span> <span class="token number">1</span> PC <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token class-name">Android</span> <span class="token punctuation">,</span> <span class="token number">3</span> IOS'<span class="token punctuation">,</span>
<span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> CHARSET<span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_log <span class="token punctuation">(</span>id<span class="token punctuation">,</span> model_name<span class="token punctuation">,</span> model_value<span class="token punctuation">,</span> return_value<span class="token punctuation">,</span> return_class<span class="token punctuation">,</span>operate_user<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> param_and_value<span class="token punctuation">,</span> operate_class<span class="token punctuation">,</span> operate_method<span class="token punctuation">,</span>cost_time，source<span class="token punctuation">)</span><span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'1'</span><span class="token punctuation">,</span><span class="token char">'user'</span><span class="token punctuation">,</span><span class="token char">'insert'</span><span class="token punctuation">,</span>'success<span class="token char">','</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token char">','</span><span class="token number">10001</span><span class="token char">','</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">0618</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">28</span><span class="token char">','</span><span class="token punctuation">{</span>\"age\"<span class="token operator">:</span>\"<span class="token number">20</span>\"<span class="token punctuation">,</span>\"name\"<span class="token operator">:</span>\"<span class="token class-name">Tom</span>\"<span class="token punctuation">,</span>\"gender\"<span class="token operator">:</span>\"<span class="token number">1</span>\"<span class="token punctuation">}</span><span class="token char">','</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span><span class="token char">','</span>insert<span class="token char">','</span><span class="token number">10</span>'<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_log <span class="token punctuation">(</span>id<span class="token punctuation">,</span> model_name<span class="token punctuation">,</span> model_value<span class="token punctuation">,</span> return_value<span class="token punctuation">,</span> return_class<span class="token punctuation">,</span>operate_user<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> param_and_value<span class="token punctuation">,</span> operate_class<span class="token punctuation">,</span> operate_method<span class="token punctuation">,</span>cost_time，source<span class="token punctuation">)</span><span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'2'</span><span class="token punctuation">,</span><span class="token char">'user'</span><span class="token punctuation">,</span><span class="token char">'insert'</span><span class="token punctuation">,</span>'success<span class="token char">','</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token char">','</span><span class="token number">10001</span><span class="token char">','</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">0618</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">27</span><span class="token char">','</span><span class="token punctuation">{</span>\"age\"<span class="token operator">:</span>\"<span class="token number">20</span>\"<span class="token punctuation">,</span>\"name\"<span class="token operator">:</span>\"<span class="token class-name">Tom</span>\"<span class="token punctuation">,</span>\"gender\"<span class="token operator">:</span>\"<span class="token number">1</span>\"<span class="token punctuation">}</span><span class="token char">','</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span><span class="token char">','</span>insert<span class="token char">','</span><span class="token number">23</span>'<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_log <span class="token punctuation">(</span>id<span class="token punctuation">,</span> model_name<span class="token punctuation">,</span> model_value<span class="token punctuation">,</span> return_value<span class="token punctuation">,</span> return_class<span class="token punctuation">,</span>operate_user<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> param_and_value<span class="token punctuation">,</span> operate_class<span class="token punctuation">,</span> operate_method<span class="token punctuation">,</span>cost_time，source<span class="token punctuation">)</span><span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'3'</span><span class="token punctuation">,</span><span class="token char">'user'</span><span class="token punctuation">,</span><span class="token char">'update'</span><span class="token punctuation">,</span>'success<span class="token char">','</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token char">','</span><span class="token number">10001</span><span class="token char">','</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">0618</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">45</span><span class="token char">','</span><span class="token punctuation">{</span>\"age\"<span class="token operator">:</span>\"<span class="token number">20</span>\"<span class="token punctuation">,</span>\"name\"<span class="token operator">:</span>\"<span class="token class-name">Tom</span>\"<span class="token punctuation">,</span>\"gender\"<span class="token operator">:</span>\"<span class="token number">1</span>\"<span class="token punctuation">}</span><span class="token char">','</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span><span class="token char">','</span>update<span class="token char">','</span><span class="token number">34</span>'<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_log <span class="token punctuation">(</span>id<span class="token punctuation">,</span> model_name<span class="token punctuation">,</span> model_value<span class="token punctuation">,</span> return_value<span class="token punctuation">,</span> return_class<span class="token punctuation">,</span>operate_user<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> param_and_value<span class="token punctuation">,</span> operate_class<span class="token punctuation">,</span> operate_method<span class="token punctuation">,</span>cost_time，source<span class="token punctuation">)</span><span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'4'</span><span class="token punctuation">,</span><span class="token char">'user'</span><span class="token punctuation">,</span><span class="token char">'update'</span><span class="token punctuation">,</span>'success<span class="token char">','</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token char">','</span><span class="token number">10001</span><span class="token char">','</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">0618</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">45</span><span class="token char">','</span><span class="token punctuation">{</span>\"age\"<span class="token operator">:</span>\"<span class="token number">20</span>\"<span class="token punctuation">,</span>\"name\"<span class="token operator">:</span>\"<span class="token class-name">Tom</span>\"<span class="token punctuation">,</span>\"gender\"<span class="token operator">:</span>\"<span class="token number">1</span>\"<span class="token punctuation">}</span><span class="token char">','</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span><span class="token char">','</span>update<span class="token char">','</span><span class="token number">13</span>'<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_log <span class="token punctuation">(</span>id<span class="token punctuation">,</span> model_name<span class="token punctuation">,</span> model_value<span class="token punctuation">,</span> return_value<span class="token punctuation">,</span> return_class<span class="token punctuation">,</span>operate_user<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> param_and_value<span class="token punctuation">,</span> operate_class<span class="token punctuation">,</span> operate_method<span class="token punctuation">,</span>cost_time，source<span class="token punctuation">)</span><span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'5'</span><span class="token punctuation">,</span><span class="token char">'user'</span><span class="token punctuation">,</span><span class="token char">'insert'</span><span class="token punctuation">,</span>'success<span class="token char">','</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token char">','</span><span class="token number">10001</span><span class="token char">','</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">0618</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">31</span><span class="token char">','</span><span class="token punctuation">{</span>\"age\"<span class="token operator">:</span>\"<span class="token number">200</span>\"<span class="token punctuation">,</span>\"name\"<span class="token operator">:</span>\"<span class="token class-name">TomCat</span>\"<span class="token punctuation">,</span>\"gender\"<span class="token operator">:</span>\"<span class="token number">0</span>\"<span class="token punctuation">}</span><span class="token char">','</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span><span class="token char">','</span>insert<span class="token char">','</span><span class="token number">29</span>'<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_log <span class="token punctuation">(</span>id<span class="token punctuation">,</span> model_name<span class="token punctuation">,</span> model_value<span class="token punctuation">,</span> return_value<span class="token punctuation">,</span> return_class<span class="token punctuation">,</span>operate_user<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> param_and_value<span class="token punctuation">,</span> operate_class<span class="token punctuation">,</span> operate_method<span class="token punctuation">,</span>cost_time，source<span class="token punctuation">)</span><span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'6'</span><span class="token punctuation">,</span><span class="token char">'user'</span><span class="token punctuation">,</span><span class="token char">'find'</span><span class="token punctuation">,</span>'success<span class="token char">','</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token char">','</span><span class="token number">10001</span><span class="token char">','</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">0618</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">31</span><span class="token char">','</span><span class="token punctuation">{</span>\"age\"<span class="token operator">:</span>\"<span class="token number">200</span>\"<span class="token punctuation">,</span>\"name\"<span class="token operator">:</span>\"<span class="token class-name">TomCat</span>\"<span class="token punctuation">,</span>\"gender\"<span class="token operator">:</span>\"<span class="token number">0</span>\"<span class="token punctuation">}</span><span class="token char">','</span><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span><span class="token char">','</span>find<span class="token char">','</span><span class="token number">29</span>'<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="3-5-3-分片规则"><a href="#3-5-3-分片规则" class="headerlink" title="3.5.3 分片规则"></a>3.5.3 分片规则</h3><h4 id="3-5-3-1-范围分片"><a href="#3-5-3-1-范围分片" class="headerlink" title="3.5.3.1 范围分片"></a>3.5.3.1 范围分片</h4><p>1). 介绍<br>根据指定的字段及其配置的范围与数据节点的对应情况， 来决定该数据属于哪一个分片。<br><img src="/images/%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87.jpg" alt="范围分片"><br>2). 配置<br>schema.xml逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dataNode<span class="token operator">=</span><span class="token string">"dn1,dn2,dn3"</span> rule<span class="token operator">=</span><span class="token string">"auto-sharding-long"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>schema.xml数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn1"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn2"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn3"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"auto-sharding-long"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>id<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>rang<span class="token operator">-</span><span class="token keyword">long</span><span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"rang-long"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.AutoPartitionByLong"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"mapFile"</span><span class="token operator">&gt;</span>autopartition<span class="token operator">-</span><span class="token keyword">long</span><span class="token punctuation">.</span>txt<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"defaultNode"</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则配置属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>mapFile</td>
<td>对应的外部配置文件</td>
</tr>
<tr>
<td>type</td>
<td>默认值为0 ; 0 表示Integer , 1 表示String</td>
</tr>
<tr>
<td>defaultNode</td>
<td>默认节点 默认节点的所用:枚举分片时,如果碰到不识别的枚举值, 就让它路由到默认节点 ; 如果没有默认值,碰到不识别的则报错 。</td>
</tr>
</tbody></table>
<p>在rule.xml中配置分片规则时，关联了一个映射配置文件 autopartition-long.txt，该配置文件的配置如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"># range start<span class="token operator">-</span>end <span class="token punctuation">,</span>data node index
# <span class="token class-name">K</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token class-name">M</span><span class="token operator">=</span><span class="token number">10000.</span>
<span class="token number">0</span><span class="token operator">-</span><span class="token number">500</span>M<span class="token operator">=</span><span class="token number">0</span>
<span class="token number">500</span>M<span class="token operator">-</span><span class="token number">1000</span>M<span class="token operator">=</span><span class="token number">1</span>
<span class="token number">1000</span>M<span class="token operator">-</span><span class="token number">1500</span>M<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>含义：0-500万之间的值，存储在0号数据节点(数据节点的索引从0开始) ； 500万-1000万之间的数据存储在1号数据节点 ； 1000万-1500万的数据节点存储在2号节点 ；<br>该分片规则，主要是针对于数字类型的字段适用。 在MyCat的入门程序中，我们使用的就是该分片规则。</p>
<h4 id="3-5-3-2-取模分片"><a href="#3-5-3-2-取模分片" class="headerlink" title="3.5.3.2 取模分片"></a>3.5.3.2 取模分片</h4><p>1). 介绍<br>根据指定的字段值与节点数量进行求模运算，根据运算结果， 来决定该数据属于哪一个分片。<br><img src="/images/%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87.jpg" alt="取模分片"><br>2). 配置<br>schema.xml逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_log"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> primaryKey<span class="token operator">=</span><span class="token string">"id"</span> rule<span class="token operator">=</span><span class="token string">"mod-long"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>schema.xml数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"mod-long"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>id<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>mod<span class="token operator">-</span><span class="token keyword">long</span><span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"mod-long"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByMod"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"count"</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性说明如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>count</td>
<td>数据节点的数量</td>
</tr>
</tbody></table>
<p>该分片规则，主要是针对于数字类型的字段适用。 在前面水平拆分的演示中，我们选择的就是取模分片。</p>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<h4 id="3-5-3-3-一致性hash分片"><a href="#3-5-3-3-一致性hash分片" class="headerlink" title="3.5.3.3 一致性hash分片"></a>3.5.3.3 一致性hash分片</h4><p>1). 介绍<br>所谓一致性哈希，相同的哈希因子计算值总是被划分到相同的分区表中，不会因为分区节点的增加而改变原来数据的分区位置，有效的解决了分布式数据的拓容问题。<br><img src="/images/%E4%B8%80%E8%87%B4%E6%80%A7hash%E5%88%86%E7%89%87.jpg" alt="一致性hash分片"><br>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 一致性hash <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_order"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-murmur"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-murmur"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>id<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>murmur<span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"murmur"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByMurmurHash"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"seed"</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 默认是<span class="token number">0</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"count"</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"virtualBucketTimes"</span><span class="token operator">&gt;</span><span class="token number">160</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>seed</td>
<td>创建murmur_hash对象的种子，默认0</td>
</tr>
<tr>
<td>count</td>
<td>要分片的数据库节点数量，必须指定，否则没法分片</td>
</tr>
<tr>
<td>virtualBucketTimes</td>
<td>一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍;virtualBucketTimes*count就是虚拟结点数量 ;</td>
</tr>
<tr>
<td>weightMapFile</td>
<td>节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替</td>
</tr>
<tr>
<td>bucketMapPath</td>
<td>用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西</td>
</tr>
</tbody></table>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">create table <span class="token function">tb_order</span><span class="token punctuation">(</span>
id <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> not <span class="token keyword">null</span> primary key<span class="token punctuation">,</span>
money <span class="token keyword">int</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
content <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b92fdaaf<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 10, '</span>b92fdaf8<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b93482b6<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 20, '</span>b93482d5<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b937e246<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 50, '</span>b937e25d<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b93be2dd<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> 'b93be2f9<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b93f2d68<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">,</span> 'b93f2d7d<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b9451b98<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 30, '</span>b9451bcc<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b9488ec1<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">560</span><span class="token punctuation">,</span> 'b9488edb<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b94be6e6<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 10, '</span>b94be6ff<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b94ee10d<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> 'b94ee12c<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b952492a<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">145</span><span class="token punctuation">,</span> 'b9524945<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b95553ac<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">543</span><span class="token punctuation">,</span> 'b95553c8<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b9581cdd<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 17, '</span>b9581cfa<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b95afc0f<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d<span class="token char">', 18, '</span>b95afc2a<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b95daa99<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">134</span><span class="token punctuation">,</span> 'b95daab2<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b9667e3c<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span> 'b9667e60<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b96ab489<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">175</span><span class="token punctuation">,</span> 'b96ab4a5<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b96e2942<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> 'b96e295b<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b97092ec<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> 'b9709306<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b973727a<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> 'b9737293<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_order <span class="token punctuation">(</span>id<span class="token punctuation">,</span> money<span class="token punctuation">,</span> content<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>'b978840f<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">,</span> <span class="token number">560</span><span class="token punctuation">,</span> 'b978843c<span class="token operator">-</span><span class="token number">6f</span>c4<span class="token operator">-</span><span class="token number">11</span>ec<span class="token operator">-</span>b831<span class="token operator">-</span><span class="token number">482</span>ae33c4a2d'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-3-4-枚举分片"><a href="#3-5-3-4-枚举分片" class="headerlink" title="3.5.3.4 枚举分片"></a>3.5.3.4 枚举分片</h4><p>1). 介绍<br>通过在配置文件中配置可能的枚举值, 指定数据分布到不同数据节点上, 本规则适用于按照省份、性别、状态拆分数据等业务 。<br><img src="/images/%E6%9E%9A%E4%B8%BE%E5%88%86%E7%89%87.jpg" alt="枚举分片"><br>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 枚举 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_user"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-intfile-enumstatus"</span><span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-intfile"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>sharding_id<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>hash<span class="token operator">-</span><span class="token keyword">int</span><span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 自己增加 tableRule <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-intfile-enumstatus"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>status<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>hash<span class="token operator">-</span><span class="token keyword">int</span><span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"hash-int"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByFileMap"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"defaultNode"</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"mapFile"</span><span class="token operator">&gt;</span>partition<span class="token operator">-</span>hash<span class="token operator">-</span><span class="token keyword">int</span><span class="token punctuation">.</span>txt<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>partition-hash-int.txt ，内容如下 :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">1</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token number">2</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token number">3</span><span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>mapFile</td>
<td>对应的外部配置文件</td>
</tr>
<tr>
<td>type</td>
<td>默认值为0 ; 0 表示Integer , 1 表示String</td>
</tr>
<tr>
<td>defaultNode</td>
<td>默认节点 ; 小于0 标识不设置默认节点 , 大于等于0代表设置默认节点 ;默认节点的所用:枚举分片时,如果碰到不识别的枚举值, 就让它路由到默认节点 ; 如果没有默认值,碰到不识别的则报错 。</td>
</tr>
</tbody></table>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CREATE <span class="token class-name">TABLE</span> tb_user <span class="token punctuation">(</span>
id <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token char">'ID'</span><span class="token punctuation">,</span>
username <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'姓名'</span><span class="token punctuation">,</span>
status <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> DEFAULT <span class="token char">'1'</span> COMMENT '<span class="token number">1</span><span class="token operator">:</span> 未启用<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> 已启用<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">:</span> 已关闭'<span class="token punctuation">,</span>
<span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> CHARSET<span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'Tom'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token char">'Cat'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'Rose'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token char">'Coco'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token char">'Lily'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token char">'Tom'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token char">'Cat'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token char">'Rose'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token char">'Coco'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_user <span class="token punctuation">(</span>id<span class="token punctuation">,</span>username <span class="token punctuation">,</span>status<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token char">'Lily'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-3-5-应用指定算法"><a href="#3-5-3-5-应用指定算法" class="headerlink" title="3.5.3.5 应用指定算法"></a>3.5.3.5 应用指定算法</h4><p>1). 介绍<br>运行阶段由应用自主决定路由到那个分片 , 直接根据字符子串（必须是数字）计算分片号。<br><img src="/images/%E5%BA%94%E7%94%A8%E6%8C%87%E5%AE%9A%E7%AE%97%E6%B3%95.jpg" alt="应用指定算法"></p>
<p>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 应用指定算法 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_app"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-substring"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-substring"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>id<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>sharding<span class="token operator">-</span>by<span class="token operator">-</span>substring<span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"sharding-by-substring"</span>
<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionDirectBySubString"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"startIndex"</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> zero<span class="token operator">-</span>based <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"size"</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"partitionCount"</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"defaultPartition"</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>startIndex</td>
<td>字符子串起始索引</td>
</tr>
<tr>
<td>size</td>
<td>字符长度</td>
</tr>
<tr>
<td>partitionCount</td>
<td>分区(分片)数量</td>
</tr>
<tr>
<td>defaultPartition</td>
<td>默认分片(在分片数量定义时, 字符标示的分片编号不在分片数量内时,使用默认分片)</td>
</tr>
</tbody></table>
<p>示例说明 :<br>id=05-100000002 , 在此配置中代表根据id中从 startIndex=0，开始，截取siz=2位数字即05，05就是获取的分区，如果没找到对应的分片则默认分配到defaultPartition 。</p>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CREATE <span class="token class-name">TABLE</span> tb_app <span class="token punctuation">(</span>
id <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token char">'ID'</span><span class="token punctuation">,</span>
name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'名称'</span><span class="token punctuation">,</span>
<span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> CHARSET<span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
insert into tb_app <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span>'<span class="token number">0000001</span><span class="token char">','</span><span class="token class-name">Testx00001</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_app <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span>'<span class="token number">0100001</span><span class="token char">','</span><span class="token class-name">Test100001</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_app <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span>'<span class="token number">0100002</span><span class="token char">','</span><span class="token class-name">Test200001</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_app <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span>'<span class="token number">0200001</span><span class="token char">','</span><span class="token class-name">Test300001</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_app <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span>'<span class="token number">0200002</span><span class="token char">','</span><span class="token class-name">TesT400001</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-3-6-固定分片hash算法"><a href="#3-5-3-6-固定分片hash算法" class="headerlink" title="3.5.3.6 固定分片hash算法"></a>3.5.3.6 固定分片hash算法</h4><p>1). 介绍<br>该算法类似于十进制的求模运算，但是为二进制的操作，例如，取 id 的二进制低 10 位 与=1111111111 进行位 &amp; 运算，位与运算最小值为 0000000000，最大值为1111111111，转换为十进制，也就是位于0-1023之间。<br><img src="/images/%E5%9B%BA%E5%AE%9A%E5%88%86%E7%89%87hash%E7%AE%97%E6%B3%95.jpg" alt="固定分片hash算法"><br>特点：</p>
<ul>
<li>如果是求模，连续的值，分别分配到各个不同的分片；但是此算法会将连续的值可能分配到相同的分片，降低事务处理的难度。</li>
<li>可以均匀分配，也可以非均匀分配。</li>
<li>分片字段必须为数字类型。</li>
</ul>
<p>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 固定分片hash算法 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_longhash"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-long-hash"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-long-hash"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>id<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>sharding<span class="token operator">-</span>by<span class="token operator">-</span><span class="token keyword">long</span><span class="token operator">-</span>hash<span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 分片总长度为<span class="token number">1024</span>，count与length数组长度必须一致； <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"sharding-by-long-hash"</span>
<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByLong"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"partitionCount"</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"partitionLength"</span><span class="token operator">&gt;</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段名</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>partitionCount</td>
<td>分片个数列表</td>
</tr>
<tr>
<td>partitionLength</td>
<td>分片范围列表</td>
</tr>
</tbody></table>
<p>约束 :</p>
<ul>
<li>1). 分片长度 : 默认最大2^10 , 为 1024 ;</li>
<li>2). count, length的数组长度必须是一致的 ;<br>以上分为三个分区:0-255,256-511,512-1023<br>示例说明 :<br><img src="/images/%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E.jpg" alt="示例说明"></li>
</ul>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CREATE <span class="token class-name">TABLE</span> tb_longhash <span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token char">'ID'</span><span class="token punctuation">,</span>
name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> DEFAULT NULL COMMENT <span class="token char">'名称'</span><span class="token punctuation">,</span>
firstChar <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> COMMENT <span class="token char">'首字母'</span><span class="token punctuation">,</span>
<span class="token class-name">PRIMARY</span> KEY <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> CHARSET<span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'七匹狼'</span><span class="token punctuation">,</span><span class="token char">'Q'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token char">'八匹狼'</span><span class="token punctuation">,</span><span class="token char">'B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'九匹狼'</span><span class="token punctuation">,</span><span class="token char">'J'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token char">'十匹狼'</span><span class="token punctuation">,</span><span class="token char">'S'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token char">'六匹狼'</span><span class="token punctuation">,</span><span class="token char">'L'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token char">'五匹狼'</span><span class="token punctuation">,</span><span class="token char">'W'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token char">'四匹狼'</span><span class="token punctuation">,</span><span class="token char">'S'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token char">'三匹狼'</span><span class="token punctuation">,</span><span class="token char">'S'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into tb_longhash <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>firstChar<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token char">'两匹狼'</span><span class="token punctuation">,</span><span class="token char">'L'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-3-7-字符串hash解析算法"><a href="#3-5-3-7-字符串hash解析算法" class="headerlink" title="3.5.3.7 字符串hash解析算法"></a>3.5.3.7 字符串hash解析算法</h4><p>1). 介绍<br>截取字符串中的指定位置的子字符串, 进行hash算法， 算出分片。<br><img src="/images/%E5%AD%97%E7%AC%A6%E4%B8%B2hash%E8%A7%A3%E6%9E%90%E7%AE%97%E6%B3%95.jpg" alt="字符串hash解析算法"><br>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 字符串hash解析算法 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_strhash"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-stringhash"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-stringhash"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>name<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>sharding<span class="token operator">-</span>by<span class="token operator">-</span>stringhash<span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"sharding-by-stringhash"</span>
<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByString"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"partitionLength"</span><span class="token operator">&gt;</span><span class="token number">512</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> zero<span class="token operator">-</span>based <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"partitionCount"</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"hashSlice"</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>partitionLength</td>
<td>hash求模基数 ; length*count=1024 (出于性能考虑)</td>
</tr>
<tr>
<td>partitionCount</td>
<td>分区数</td>
</tr>
<tr>
<td>hashSlice</td>
<td>hash运算位 , 根据子字符串的hash运算 ; 0 代表 str.length(), -1 代表 str.length()-1 , 大于0只代表数字自身 ; 可以理解为substring（start，end），start为0则只表示0</td>
</tr>
</tbody></table>
<p>示例说明：<br><img src="/images/%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E1.jpg" alt="示例说明1"><br>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">create table <span class="token function">tb_strhash</span><span class="token punctuation">(</span>
name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> primary key<span class="token punctuation">,</span>
content <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>engine<span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token class-name">DEFAULT</span> CHARSET<span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_strhash <span class="token punctuation">(</span>name<span class="token punctuation">,</span>content<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'T1001'</span><span class="token punctuation">,</span> <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_strhash <span class="token punctuation">(</span>name<span class="token punctuation">,</span>content<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'ROSE'</span><span class="token punctuation">,</span> <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_strhash <span class="token punctuation">(</span>name<span class="token punctuation">,</span>content<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'JERRY'</span><span class="token punctuation">,</span> <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_strhash <span class="token punctuation">(</span>name<span class="token punctuation">,</span>content<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span>'CRISTINA'<span class="token punctuation">,</span> <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT <span class="token class-name">INTO</span> tb_strhash <span class="token punctuation">(</span>name<span class="token punctuation">,</span>content<span class="token punctuation">)</span> <span class="token function">VALUES</span><span class="token punctuation">(</span><span class="token char">'TOMCAT'</span><span class="token punctuation">,</span> <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-3-8-按天分片算法"><a href="#3-5-3-8-按天分片算法" class="headerlink" title="3.5.3.8 按天分片算法"></a>3.5.3.8 按天分片算法</h4><p>1). 介绍<br>按照日期及对应的时间周期来分片。<br><img src="/images/%E6%8C%89%E5%A4%A9%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95.jpg" alt="按天分片算法"><br>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 按天分片 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_datepart"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-date"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-date"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>create_time<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>sharding<span class="token operator">-</span>by<span class="token operator">-</span>date<span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"sharding-by-date"</span>
<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByDate"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"dateFormat"</span><span class="token operator">&gt;</span>yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"sBeginDate"</span><span class="token operator">&gt;</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"sEndDate"</span><span class="token operator">&gt;</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"sPartionDay"</span><span class="token operator">&gt;</span><span class="token number">10</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
从开始时间开始，每<span class="token number">10</span>天为一个分片，到达结束时间之后，会重复开始分片插入
配置表的 dataNode 的分片，必须和分片规则数量一致，例如 <span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> 到 <span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> ，每
<span class="token number">10</span>天一个分片，一共需要<span class="token number">37</span>个分片。
<span class="token operator">--</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>dateFormat</td>
<td>日期格式</td>
</tr>
<tr>
<td>sBeginDate</td>
<td>开始日期</td>
</tr>
<tr>
<td>sEndDate</td>
<td>结束日期，如果配置了结束日期，则代码数据到达了这个日期的分片后，会重复从开始分片插入</td>
</tr>
<tr>
<td>sPartionDay</td>
<td>分区天数，默认值 10 ，从开始日期算起，每个10天一个分区</td>
</tr>
</tbody></table>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">create table <span class="token function">tb_datepart</span><span class="token punctuation">(</span>
id bigint not <span class="token keyword">null</span> comment <span class="token char">'ID'</span> primary key<span class="token punctuation">,</span>
name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">null</span> comment <span class="token char">'姓名'</span><span class="token punctuation">,</span>
create_time date <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'Tom'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token char">'Cat'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">10</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'Rose'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">11</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token char">'Coco'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token char">'Rose2'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">21</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token char">'Coco2'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">30</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_datepart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token char">'Coco3'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">31</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-5-3-9-自然月分片"><a href="#3-5-3-9-自然月分片" class="headerlink" title="3.5.3.9 自然月分片"></a>3.5.3.9 自然月分片</h4><p>1). 介绍<br>使用场景为按照月份来分片, 每个自然月为一个分片。<br><img src="/images/%E8%87%AA%E7%84%B6%E6%9C%88%E5%88%86%E7%89%87.jpg" alt="自然月分片"><br>2). 配置<br>schema.xml中逻辑表配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 按自然月分片 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"tb_monthpart"</span> dataNode<span class="token operator">=</span><span class="token string">"dn4,dn5,dn6"</span> rule<span class="token operator">=</span><span class="token string">"sharding-by-month"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>schema.xml中数据节点配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn4"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost1"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn5"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost2"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn6"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost3"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>rule.xml中分片规则配置：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>tableRule name<span class="token operator">=</span><span class="token string">"sharding-by-month"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>rule<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>columns<span class="token punctuation">&gt;</span></span>create_time<span class="token operator">&lt;</span><span class="token operator">/</span>columns<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>algorithm<span class="token punctuation">&gt;</span></span>partbymonth<span class="token operator">&lt;</span><span class="token operator">/</span>algorithm<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>rule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tableRule<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>function name<span class="token operator">=</span><span class="token string">"partbymonth"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"io.mycat.route.function.PartitionByMonth"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"dateFormat"</span><span class="token operator">&gt;</span>yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"sBeginDate"</span><span class="token operator">&gt;</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"sEndDate"</span><span class="token operator">&gt;</span><span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>function<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
从开始时间开始，一个月为一个分片，到达结束时间之后，会重复开始分片插入
配置表的 dataNode 的分片，必须和分片规则数量一致，例如 <span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> 到 <span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> ，一
共需要<span class="token number">12</span>个分片。
<span class="token operator">--</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分片规则属性含义：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>columns</td>
<td>标识将要分片的表字段</td>
</tr>
<tr>
<td>algorithm</td>
<td>指定分片函数与function的对应关系</td>
</tr>
<tr>
<td>class</td>
<td>指定该分片算法对应的类</td>
</tr>
<tr>
<td>dateFormat</td>
<td>日期格式</td>
</tr>
<tr>
<td>sBeginDate</td>
<td>开始日期</td>
</tr>
<tr>
<td>sEndDate</td>
<td>结束日期，如果配置了结束日期，则代码数据到达了这个日期的分片后，会重复从开始分片插入</td>
</tr>
</tbody></table>
<p>3). 测试<br>配置完毕后，重新启动MyCat，然后在mycat的命令行中，执行如下SQL创建表、并插入数据，查看数据分布情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">create table <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>
id bigint not <span class="token keyword">null</span> comment <span class="token char">'ID'</span> primary key<span class="token punctuation">,</span>
name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">null</span> comment <span class="token char">'姓名'</span><span class="token punctuation">,</span>
create_time date <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'Tom'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token char">'Cat'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">10</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'Rose'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">31</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token char">'Coco'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">20</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token char">'Rose2'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">25</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token char">'Coco2'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">10</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token char">'Coco3'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token char">'Coco4'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_monthpart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name <span class="token punctuation">,</span>create_time<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token char">'Coco5'</span><span class="token punctuation">,</span>'<span class="token number">2022</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">30</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-6-MyCat管理及监控"><a href="#3-6-MyCat管理及监控" class="headerlink" title="3.6 MyCat管理及监控"></a>3.6 MyCat管理及监控</h2><h3 id="3-6-1-MyCat原理"><a href="#3-6-1-MyCat原理" class="headerlink" title="3.6.1 MyCat原理"></a>3.6.1 MyCat原理</h3><p><img src="/images/MyCat%E5%8E%9F%E7%90%86.jpg" alt="MyCat原理"></p>
<p>在MyCat中，当执行一条SQL语句时，MyCat需要进行SQL解析、分片分析、路由分析、读写分离分析等操作，最终经过一系列的分析决定将当前的SQL语句到底路由到那几个(或哪一个)节点数据库，数据库将数据执行完毕后，如果有返回的结果，则将结果返回给MyCat，最终还需要在MyCat中进行结果合并、聚合处理、排序处理、分页处理等操作，最终再将结果返回给客户端。<br>而在MyCat的使用过程中，MyCat官方也提供了一个管理监控平台MyCat-Web（MyCat-eye）。Mycat-web 是 Mycat 可视化运维的管理和监控平台，弥补了 Mycat 在监控上的空白。帮 Mycat分担统计任务和配置管理任务。Mycat-web 引入了 ZooKeeper 作为配置中心，可以管理多个节点。Mycat-web 主要管理和监控 Mycat 的流量、连接、活动线程和内存等，具备 IP 白名单、邮件告警等模块，还可以统计 SQL 并分析慢 SQL 和高频 SQL 等。为优化 SQL 提供依据。</p>
<h3 id="3-6-2-MyCat管理"><a href="#3-6-2-MyCat管理" class="headerlink" title="3.6.2 MyCat管理"></a>3.6.2 MyCat管理</h3><p>Mycat默认开通2个端口，可以在server.xml中进行修改。</p>
<ul>
<li>8066 数据访问端口，即进行 DML 和 DDL 操作。</li>
<li>9066 数据库管理端口，即 mycat 服务管理控制功能，用于管理mycat的整个集群状态<br>连接MyCat的管理控制台：<pre class="line-numbers language-java" data-language="java"><code class="language-java">mysql <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.210</span> <span class="token operator">-</span>p <span class="token number">9066</span> <span class="token operator">-</span>uroot <span class="token operator">-</span>p123456<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>show @@help</td>
<td>查看Mycat管理工具帮助文档</td>
</tr>
<tr>
<td>show @@version</td>
<td>查看Mycat的版本</td>
</tr>
<tr>
<td>reload @@config</td>
<td>重新加载Mycat的配置文件</td>
</tr>
<tr>
<td>show @@datasource</td>
<td>查看Mycat的数据源信息</td>
</tr>
<tr>
<td>show @@datanode</td>
<td>查看MyCat现有的分片节点信息</td>
</tr>
<tr>
<td>show @@threadpool</td>
<td>查看Mycat的线程池信息</td>
</tr>
<tr>
<td>show @@sql</td>
<td>查看执行的SQL</td>
</tr>
<tr>
<td>show @@sql.sum</td>
<td>查看执行的SQL统计</td>
</tr>
</tbody></table>
<h3 id="3-6-3-MyCat-eye"><a href="#3-6-3-MyCat-eye" class="headerlink" title="3.6.3 MyCat-eye"></a>3.6.3 MyCat-eye</h3><h4 id="3-6-3-1-介绍"><a href="#3-6-3-1-介绍" class="headerlink" title="3.6.3.1 介绍"></a>3.6.3.1 介绍</h4><p>Mycat-web(Mycat-eye)是对mycat-server提供监控服务，功能不局限于对mycat-server使用。他通过JDBC连接对Mycat、Mysql监控，监控远程服务器(目前仅限于linux系统)的cpu、内存、网络、磁盘。<br>Mycat-eye运行过程中需要依赖zookeeper，因此需要先安装zookeeper。<br>3.6.3.2 安装<br>1). zookeeper安装<br>2). Mycat-web安装<br>具体的安装步骤，请参考资料中提供的《MyCat-Web安装文档》</p>
<h4 id="3-6-3-3-访问"><a href="#3-6-3-3-访问" class="headerlink" title="3.6.3.3 访问"></a>3.6.3.3 访问</h4><p><a target="_blank" rel="noopener" href="http://192.168.200.210:8082/mycat">http://192.168.200.210:8082/mycat</a><br><img src="/images/zookeeper%E5%AE%89%E8%A3%85.jpg" alt="zookeeper安装"></p>
<h4 id="3-6-3-4-配置"><a href="#3-6-3-4-配置" class="headerlink" title="3.6.3.4 配置"></a>3.6.3.4 配置</h4><p>1). 开启MyCat的实时统计功能(server.xml)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"useSqlStat"</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token number">1</span> <span class="token number">1</span>为开启实时统计、<span class="token number">0</span>为关闭 <span class="token operator">--</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2). 在Mycat监控界面配置服务地址<br><img src="/images/Mycat%E7%9B%91%E6%8E%A7%E7%95%8C%E9%9D%A2%E9%85%8D%E7%BD%AE.jpg" alt="Mycat监控界面配置"></p>
<h4 id="3-6-3-5-测试"><a href="#3-6-3-5-测试" class="headerlink" title="3.6.3.5 测试"></a>3.6.3.5 测试</h4><p>配置好了之后，我们可以通过MyCat执行一系列的增删改查的测试，然后过一段时间之后，打开mycat-eye的管理界面，查看mycat-eye监控到的数据信息。<br>A. 性能监控<br><img src="/images/%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7.jpg" alt="性能监控"><br>B. 物理节点<br><img src="/images/%E7%89%A9%E7%90%86%E8%8A%82%E7%82%B9.jpg" alt="物理节点"><br>C. SQL统计<br><img src="/images/SQL%E7%BB%9F%E8%AE%A1.jpg" alt="SQL统计"><br>D. SQL表分析<br><img src="/images/SQL%E8%A1%A8%E5%88%86%E6%9E%90.jpg" alt="SQL表分析"><br>E. SQL监控<br><img src="/images/SQL%E7%9B%91%E6%8E%A7.jpg" alt="SQL监控"><br>F. 高频SQL<br><img src="/images/%E9%AB%98%E9%A2%91SQL.jpg" alt="高频SQL"></p>
<h1 id="4-读写分离"><a href="#4-读写分离" class="headerlink" title="4. 读写分离"></a>4. 读写分离</h1><h2 id="4-1-介绍"><a href="#4-1-介绍" class="headerlink" title="4.1 介绍"></a>4.1 介绍</h2><p>读写分离,简单地说是把对数据库的读和写操作分开,以对应不同的数据库服务器。主数据库提供写操作，从数据库提供读操作，这样能有效地减轻单台数据库的压力。<br>通过MyCat即可轻易实现上述功能，不仅可以支持MySQL，也可以支持Oracle和SQL Server。<br><img src="/images/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.jpg" alt="读写分离"></p>
<h2 id="4-2-一主一从"><a href="#4-2-一主一从" class="headerlink" title="4.2 一主一从"></a>4.2 一主一从</h2><h3 id="4-2-1-原理"><a href="#4-2-1-原理" class="headerlink" title="4.2.1 原理"></a>4.2.1 原理</h3><p>MySQL的主从复制，是基于二进制日志（binlog）实现的。<br><img src="/images/%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E.jpg" alt="一主一从"></p>
<h3 id="4-2-2-准备"><a href="#4-2-2-准备" class="headerlink" title="4.2.2 准备"></a>4.2.2 准备</h3><table>
<thead>
<tr>
<th>主机</th>
<th>角色</th>
<th>用户名</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.200.211</td>
<td>master</td>
<td>root</td>
<td>1234</td>
</tr>
<tr>
<td>192.168.200.212</td>
<td>slave</td>
<td>root</td>
<td>1234</td>
</tr>
</tbody></table>
<p>备注：主从复制的搭建，可以参考前面课程中 主从复制 章节讲解的步骤操作。</p>
<h2 id="4-3-一主一从读写分离"><a href="#4-3-一主一从读写分离" class="headerlink" title="4.3 一主一从读写分离"></a>4.3 一主一从读写分离</h2><p>MyCat控制后台数据库的读写分离和负载均衡由schema.xml文件datahost标签的balance属性控制。</p>
<h3 id="4-3-1-schema-xml配置"><a href="#4-3-1-schema-xml配置" class="headerlink" title="4.3.1 schema.xml配置"></a>4.3.1 schema.xml配置</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 配置逻辑库 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"ITCAST_RW"</span> checkSQLschema<span class="token operator">=</span><span class="token string">"true"</span> sqlMaxLimit<span class="token operator">=</span><span class="token string">"100"</span> dataNode<span class="token operator">=</span><span class="token string">"dn7"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn7"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost7"</span> database<span class="token operator">=</span><span class="token string">"itcast"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost7"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"1"</span> writeType<span class="token operator">=</span><span class="token string">"0"</span>
dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span> slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master1"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>readHost host<span class="token operator">=</span><span class="token string">"slave1"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>writeHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述配置的具体关联对应情况如下：<br><img src="/images/%E5%85%B3%E8%81%94%E5%AF%B9%E5%BA%94%E6%83%85%E5%86%B5.jpg" alt="关联对应情况"><br>writeHost代表的是写操作对应的数据库，readHost代表的是读操作对应的数据库。 所以我们要想实现读写分离，就得配置writeHost关联的是主库，readHost关联的是从库。<br>而仅仅配置好了writeHost以及readHost还不能完成读写分离，还需要配置一个非常重要的负责均衡的参数 balance，取值有4种，具体含义如下：</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>不开启读写分离机制 , 所有读操作都发送到当前可用的writeHost上</td>
</tr>
<tr>
<td>1</td>
<td>全部的readHost 与 备用的writeHost 都参与select 语句的负载均衡（主要针对于双主双从模式）</td>
</tr>
<tr>
<td>2</td>
<td>所有的读写操作都随机在writeHost , readHost上分发</td>
</tr>
<tr>
<td>3</td>
<td>所有的读请求随机分发到writeHost对应的readHost上执行, writeHost不负担读压力</td>
</tr>
</tbody></table>
<p>所以，在一主一从模式的读写分离中，balance配置1或3都是可以完成读写分离的。</p>
<h3 id="4-3-2-server-xml配置"><a href="#4-3-2-server-xml配置" class="headerlink" title="4.3.2 server.xml配置"></a>4.3.2 server.xml配置</h3><p>配置root用户可以访问SHOPPING、ITCAST 以及 ITCAST_RW逻辑库。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"root"</span> defaultAccount<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>SHOPPING<span class="token punctuation">,</span>ITCAST<span class="token punctuation">,</span>ITCAST_RW<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 表级 DML 权限设置 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
<span class="token operator">&lt;</span>privileges check<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"DB01"</span> dml<span class="token operator">=</span><span class="token string">"0110"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dml<span class="token operator">=</span><span class="token string">"1110"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>privileges<span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-3-测试"><a href="#4-3-3-测试" class="headerlink" title="4.3.3 测试"></a>4.3.3 测试</h3><p>配置完毕MyCat后，重新启动MyCat。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">bin<span class="token operator">/</span>mycat stop
bin<span class="token operator">/</span>mycat start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后观察，在执行增删改操作时，对应的主库及从库的数据变化。 在执行查询操作时，检查主库及从库对应的数据变化。<br>在测试中，我们可以发现当主节点Master宕机之后，业务系统就只能够读，而不能写入数据了。<br><img src="/images/Master%E5%AE%95%E6%9C%BA.jpg" alt="Master宕机"><br>那如何解决这个问题呢？这个时候我们就得通过另外一种主从复制结构来解决了，也就是我们接下来讲解的双主双从。</p>
<h2 id="4-4-双主双从"><a href="#4-4-双主双从" class="headerlink" title="4.4 双主双从"></a>4.4 双主双从</h2><h3 id="4-4-1-介绍"><a href="#4-4-1-介绍" class="headerlink" title="4.4.1 介绍"></a>4.4.1 介绍</h3><p>一个主机 Master1 用于处理所有写请求，它的从机 Slave1 和另一台主机 Master2 还有它的从机 Slave2 负责所有读请求。当 Master1 主机宕机后，Master2 主机负责写请求，Master1 、<br>Master2 互为备机。架构图如下:<br><img src="/images/%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E.jpg" alt="双主双从"></p>
<h3 id="4-4-2-准备"><a href="#4-4-2-准备" class="headerlink" title="4.4.2 准备"></a>4.4.2 准备</h3><p>我们需要准备5台服务器，具体的服务器及软件安装情况如下：</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>IP</th>
<th>预装软件</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>192.168.200.210</td>
<td>MyCat、MySQL</td>
<td>MyCat中间件服务器</td>
</tr>
<tr>
<td>2</td>
<td>192.168.200.211</td>
<td>MySQL</td>
<td>M1</td>
</tr>
<tr>
<td>3</td>
<td>192.168.200.212</td>
<td>MySQL</td>
<td>S1</td>
</tr>
<tr>
<td>4</td>
<td>192.168.200.213</td>
<td>MySQL</td>
<td>M2</td>
</tr>
<tr>
<td>5</td>
<td>192.168.200.214</td>
<td>MySQL</td>
<td>S2</td>
</tr>
</tbody></table>
<p>关闭以上所有服务器的防火墙：<br>systemctl stop firewalld<br>systemctl disable firewalld</p>
<h3 id="4-4-3-搭建"><a href="#4-4-3-搭建" class="headerlink" title="4.4.3 搭建"></a>4.4.3 搭建</h3><h4 id="4-4-3-1-主库配置"><a href="#4-4-3-1-主库配置" class="headerlink" title="4.4.3.1 主库配置"></a>4.4.3.1 主库配置</h4><p>1). Master1(192.168.200.211)<br><img src="/images/%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE.jpg" alt="主库配置"><br>A. 修改配置文件 /etc/my.cnf</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#mysql 服务ID，保证整个集群环境中唯一，取值范围：<span class="token number">1</span> – <span class="token number">2</span><span class="token operator">^</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">1</span>，默认为<span class="token number">1</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span>
#指定同步的数据库
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db01
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db02
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db03
# 在作为从数据库的时候，有写入操作也要更新二进制日志文件
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>B. 重启MySQL服务器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">systemctl restart mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>C. 创建账户并授权</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#创建itcast用户，并设置密码，该用户可在任意主机连接该<span class="token class-name">MySQL</span>服务
CREATE USER <span class="token char">'itcast'</span>@<span class="token char">'%'</span> IDENTIFIED WITH mysql_native_password BY '<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">;</span>
#为 <span class="token char">'itcast'</span>@<span class="token char">'%'</span> 用户分配主从复制权限
GRANT REPLICATION SLAVE ON <span class="token operator">*</span><span class="token punctuation">.</span>* TO <span class="token char">'itcast'</span>@<span class="token char">'%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过指令，查看两台主库的二进制日志坐标</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">show master status <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E6%9F%A5%E7%9C%8B%E4%B8%A4%E5%8F%B0%E4%B8%BB%E5%BA%93.jpg" alt="查看两台主库"><br>2). Master2(192.168.200.213)<br><img src="/images/%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE1.jpg" alt="主库配置1"><br>A. 修改配置文件 /etc/my.cnf</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#mysql 服务ID，保证整个集群环境中唯一，取值范围：<span class="token number">1</span> – <span class="token number">2</span><span class="token operator">^</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">1</span>，默认为<span class="token number">1</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">3</span>
#指定同步的数据库
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db01
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db02
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span>db03
# 在作为从数据库的时候，有写入操作也要更新二进制日志文件
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>B. 重启MySQL服务器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">systemctl restart mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>C. 创建账户并授权</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#创建itcast用户，并设置密码，该用户可在任意主机连接该<span class="token class-name">MySQL</span>服务
CREATE USER <span class="token char">'itcast'</span>@<span class="token char">'%'</span> IDENTIFIED WITH mysql_native_password BY '<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">;</span>
#为 <span class="token char">'itcast'</span>@<span class="token char">'%'</span> 用户分配主从复制权限
GRANT REPLICATION SLAVE ON <span class="token operator">*</span><span class="token punctuation">.</span>* TO <span class="token char">'itcast'</span>@<span class="token char">'%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过指令，查看两台主库的二进制日志坐标</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">show  master status <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97%E5%9D%90%E6%A0%87.jpg" alt="二进制日志坐标"></p>
<h4 id="4-4-3-2-从库配置"><a href="#4-4-3-2-从库配置" class="headerlink" title="4.4.3.2 从库配置"></a>4.4.3.2 从库配置</h4><p>1). Slave1(192.168.200.212)<br><img src="/images/%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE2.jpg" alt="主库配置2"><br>A. 修改配置文件 /etc/my.cnf</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#mysql 服务ID，保证整个集群环境中唯一，取值范围：<span class="token number">1</span> – <span class="token number">232</span><span class="token operator">-</span><span class="token number">1</span>，默认为<span class="token number">1</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>B. 重新启动MySQL服务器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">systemctl restart mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2). Slave2(192.168.200.214)<br><img src="/images/%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE3.jpg" alt="主库配置3"><br>A. 修改配置文件 /etc/my.cnf</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#mysql 服务ID，保证整个集群环境中唯一，取值范围：<span class="token number">1</span> – <span class="token number">232</span><span class="token operator">-</span><span class="token number">1</span>，默认为<span class="token number">1</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>B. 重新启动MySQL服务器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">systemctl restart mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="4-4-3-3-从库关联主库"><a href="#4-4-3-3-从库关联主库" class="headerlink" title="4.4.3.3 从库关联主库"></a>4.4.3.3 从库关联主库</h4><p>1). 两台从库配置关联的主库<br><img src="/images/%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE4.jpg" alt="主库配置4"><br>需要注意slave1对应的是master1，slave2对应的是master2。<br>A. 在 slave1(192.168.200.212)上执行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CHANGE MASTER <span class="token class-name">TO</span> MASTER_HOST<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.211</span>'<span class="token punctuation">,</span> MASTER_USER<span class="token operator">=</span><span class="token char">'itcast'</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span>'<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span>'binlog<span class="token punctuation">.</span><span class="token number">000002</span>'<span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">663</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>B. 在 slave2(192.168.200.214)上执行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CHANGE MASTER <span class="token class-name">TO</span> MASTER_HOST<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.213</span>'<span class="token punctuation">,</span> MASTER_USER<span class="token operator">=</span><span class="token char">'itcast'</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span>'<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span>'binlog<span class="token punctuation">.</span><span class="token number">000002</span>'<span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">663</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>C. 启动两台从库主从复制，查看从库状态</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">start slave<span class="token punctuation">;</span>
show slave status \<span class="token class-name">G</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>2). 两台主库相互复制<br><img src="/images/%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE5.jpg" alt="主库配置5"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Master2</span> 复制 <span class="token class-name">Master1</span>，<span class="token class-name">Master1</span> 复制 <span class="token class-name">Master2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>A. 在 Master1(192.168.200.211)上执行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CHANGE MASTER <span class="token class-name">TO</span> MASTER_HOST<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.213</span>'<span class="token punctuation">,</span> MASTER_USER<span class="token operator">=</span><span class="token char">'itcast'</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span>'<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span>'binlog<span class="token punctuation">.</span><span class="token number">000002</span>'<span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">663</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>B. 在 Master2(192.168.200.213)上执行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">CHANGE MASTER <span class="token class-name">TO</span> MASTER_HOST<span class="token operator">=</span>'<span class="token number">192.168</span><span class="token number">.200</span><span class="token number">.211</span>'<span class="token punctuation">,</span> MASTER_USER<span class="token operator">=</span><span class="token char">'itcast'</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span>'<span class="token class-name">Root</span><span class="token annotation punctuation">@123456</span>'<span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span>'binlog<span class="token punctuation">.</span><span class="token number">000002</span>'<span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span><span class="token number">663</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>C. 启动两台从库主从复制，查看从库状态</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">start slave<span class="token punctuation">;</span>
show slave status \<span class="token class-name">G</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>经过上述的三步配置之后，双主双从的复制结构就已经搭建完成了。 接下来，我们可以来测试验证一下。</p>
<h3 id="4-4-4-测试"><a href="#4-4-4-测试" class="headerlink" title="4.4.4 测试"></a>4.4.4 测试</h3><p>分别在两台主库Master1、Master2上执行DDL、DML语句，查看涉及到的数据库服务器的数据同步情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">create database db01<span class="token punctuation">;</span>
use db01<span class="token punctuation">;</span>
create table <span class="token function">tb_user</span><span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> not <span class="token keyword">null</span> primary key <span class="token punctuation">,</span>
name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> not <span class="token keyword">null</span><span class="token punctuation">,</span>
sex <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>engine<span class="token operator">=</span>innodb <span class="token keyword">default</span> charset<span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
insert into <span class="token function">tb_user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token char">'Tom'</span><span class="token punctuation">,</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>'<span class="token class-name">Trigger</span><span class="token char">','</span><span class="token number">0</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token char">'Dawn'</span><span class="token punctuation">,</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>'<span class="token class-name">Jack</span> <span class="token class-name">Ma</span><span class="token char">','</span><span class="token number">1</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token char">'Coco'</span><span class="token punctuation">,</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into <span class="token function">tb_user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token char">'Jerry'</span><span class="token punctuation">,</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>在Master1中执行DML、DDL操作，看看数据是否可以同步到另外的三台数据库中。</li>
<li>在Master2中执行DML、DDL操作，看看数据是否可以同步到另外的三台数据库中。<br>完成了上述双主双从的结构搭建之后，接下来，我们再来看看如何完成这种双主双从的读写分离。</li>
</ul>
<h2 id="4-5-双主双从读写分离"><a href="#4-5-双主双从读写分离" class="headerlink" title="4.5 双主双从读写分离"></a>4.5 双主双从读写分离</h2><h3 id="4-5-1-配置"><a href="#4-5-1-配置" class="headerlink" title="4.5.1 配置"></a>4.5.1 配置</h3><p>MyCat控制后台数据库的读写分离和负载均衡由schema.xml文件datahost标签的balance属性控制，通过writeType及switchType来完成失败自动切换的。<br>1). schema.xml<br>配置逻辑库：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"ITCAST_RW2"</span> checkSQLschema<span class="token operator">=</span><span class="token string">"true"</span> sqlMaxLimit<span class="token operator">=</span><span class="token string">"100"</span> dataNode<span class="token operator">=</span><span class="token string">"dn7"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>配置数据节点：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataNode name<span class="token operator">=</span><span class="token string">"dn7"</span> dataHost<span class="token operator">=</span><span class="token string">"dhost7"</span> database<span class="token operator">=</span><span class="token string">"db01"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>配置节点主机：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>dataHost name<span class="token operator">=</span><span class="token string">"dhost7"</span> maxCon<span class="token operator">=</span><span class="token string">"1000"</span> minCon<span class="token operator">=</span><span class="token string">"10"</span> balance<span class="token operator">=</span><span class="token string">"1"</span> writeType<span class="token operator">=</span><span class="token string">"0"</span>dbType<span class="token operator">=</span><span class="token string">"mysql"</span> dbDriver<span class="token operator">=</span><span class="token string">"jdbc"</span> switchType<span class="token operator">=</span><span class="token string">"1"</span> slaveThreshold<span class="token operator">=</span><span class="token string">"100"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>heartbeat<span class="token punctuation">&gt;</span></span>select <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>heartbeat<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master1"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>readHost host<span class="token operator">=</span><span class="token string">"slave1"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>writeHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>writeHost host<span class="token operator">=</span><span class="token string">"master2"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.213:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>readHost host<span class="token operator">=</span><span class="token string">"slave2"</span> url<span class="token operator">=</span><span class="token string">"jdbc:mysql://192.168.200.214:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8"</span>user<span class="token operator">=</span><span class="token string">"root"</span> password<span class="token operator">=</span><span class="token string">"1234"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>writeHost<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dataHost<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体的对应情况如下：<br><img src="/images/%E5%85%B7%E4%BD%93%E7%9A%84%E5%AF%B9%E5%BA%94%E6%83%85%E5%86%B5%E5%A6%82%E4%B8%8B.jpg" alt="具体的对应情况如下"><br>属性说明：<br>balance=”1”</p>
<ul>
<li>代表全部的 readHost 与 stand by writeHost 参与 select 语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情况下，M2,S1,S2 都参与 select 语句的负载均衡 ;<br>writeType</li>
<li>0 : 写操作都转发到第1台writeHost, writeHost1挂了, 会切换到writeHost2上;</li>
<li>1 : 所有的写操作都随机地发送到配置的writeHost上 ;<br>switchType</li>
<li>-1 : 不自动切换</li>
<li>1 : 自动切换</li>
</ul>
<p>2). user.xml<br>配置root用户也可以访问到逻辑库 ITCAST_RW2。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>user name<span class="token operator">=</span><span class="token string">"root"</span> defaultAccount<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span><span class="token number">123456</span><span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"schemas"</span><span class="token operator">&gt;</span>SHOPPING<span class="token punctuation">,</span>ITCAST<span class="token punctuation">,</span>ITCAST_RW2<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 表级 DML 权限设置 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
<span class="token operator">&lt;</span>privileges check<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>schema name<span class="token operator">=</span><span class="token string">"DB01"</span> dml<span class="token operator">=</span><span class="token string">"0110"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>table name<span class="token operator">=</span><span class="token string">"TB_ORDER"</span> dml<span class="token operator">=</span><span class="token string">"1110"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>schema<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>privileges<span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>user<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>






































































































































































































































































































































































































































































































































































                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">wb</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://wangbin5920.github.io/2021/05/15/mysql-yun-wei/">http://wangbin5920.github.io/2021/05/15/mysql-yun-wei/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">wb</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MySQL-%E8%BF%90%E7%BB%B4/">
                                    <span class="chip bg-color">MySQL 运维</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/05/15/mysql-jin-jie/">
                    <div class="card-image">
                        
                        <img src="/images/MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.jpg" class="responsive-img" alt="MySQL 进阶">
                        
                        <span class="card-title">MySQL 进阶</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            MySQL 是一款安全、跨平台、高效的，并与 PHP、Java 等主流编程语言紧密结合的数据库系统。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-05-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MySQL-%E8%BF%9B%E9%98%B6/">
                        <span class="chip bg-color">MySQL 进阶</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/04/30/javase-ji-he/">
                    <div class="card-image">
                        
                        <img src="/images/JavaSE%E9%9B%86%E5%90%88.png" class="responsive-img" alt="JavaSE 集合">
                        
                        <span class="card-title">JavaSE 集合</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            语言：人与人交流沟通的表达方式。 计算机语言：人与计算机之间进行信息交流沟通的一种特殊语言。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-04-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%90%8E%E7%AB%AF/" class="post-category">
                                    后端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/JavaSE-%E9%9B%86%E5%90%88/">
                        <span class="chip bg-color">JavaSE 集合</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <a href="/about" target="_blank">wb</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">127.8k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "3";
                        var startDate = "15";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wangbin5920" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:375314196@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=375314196" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 375314196" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
